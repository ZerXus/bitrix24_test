
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?168833129470830";s:6:"source";s:69:"/bitrix/components/bitrix/main.post.form/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.map.js";}"*/
(function(){if(window["LHEPostForm"]){return}this.BX=this.BX||{};(function(e,t,i,n,r){"use strict";var a=function(){function e(t,i){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id","SomeParser");babelHelpers.defineProperty(this,"buttonParams",{name:"Some parser name",iconClassName:"some-parser-class",disabledForTextarea:false,src:"/icon.png",toolbarSort:205});this.editor=t;this.htmlEditor=i;this.handler=this.handler.bind(this)}babelHelpers.createClass(e,[{key:"handler",value:function e(){}},{key:"parse",value:function e(t){return t}},{key:"unparse",value:function e(t,i){return""}},{key:"hasButton",value:function e(){return this.buttonParams!==null}},{key:"getButton",value:function e(){if(this.buttonParams===null){return null}return{id:this.id,name:this.buttonParams.name,iconClassName:this.buttonParams.iconClassName,disabledForTextarea:this.buttonParams.disabledForTextarea,src:this.buttonParams.src,toolbarSort:this.buttonParams.toolbarSort,handler:this.handler}}},{key:"getParser",value:function e(){var t=this;return{name:this.id,obj:{Parse:function e(i,n){return t.parse(n)},UnParse:this.unparse.bind(this)}}}}]);return e}();var o=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),o=0;o<n;o++){a[o]=arguments[o]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"id","spoiler");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"buttonParams",{name:r.Loc.getMessage("MPF_SPOILER"),iconClassName:"spoiler",disabledForTextarea:false,src:r.Loc.getMessage("MPF_TEMPLATE_FOLDER")+"/images/lhespoiler.svg",toolbarSort:205});return i}babelHelpers.createClass(t,[{key:"handler",value:function e(){var t;if(!this.htmlEditor.bbCode||!this.htmlEditor.synchro.IsFocusedOnTextarea()){t=this.htmlEditor.action.actions.formatBlock.exec("formatBlock","blockquote","bx-spoiler",false,{bxTagParams:{tag:"spoiler"}})}else{t=this.htmlEditor.action.actions.formatBbCode.exec("quote",{tag:"SPOILER"})}return t}},{key:"parse",value:function e(t,i){if(/\[spoiler(([^\]])*)\]/gi.test(t)){t=t.replace(/[\x01-\x02]/gi,"").replace(/\[spoiler([^\]]*)\]/gi,"\x01$1\x01").replace(/\[\/spoiler]/gi,"\x02");var n=/(?:\x01([^\x01]*)\x01)([^\x01-\x02]+)\x02/gi;while(t.match(n)){t=t.replace(n,function(e,t,i){t=t.replace(/^(="|='|=)/gi,"").replace(/("|')?$/gi,"");return'<blockquote class="bx-spoiler" id="'.concat(this.htmlEditor.SetBxTag(false,{tag:"spoiler"}),'" title="').concat(t,'">').concat(i,"</blockquote>")}.bind(this))}}t=t.replace(/\001([^\001]*)\001/gi,"[spoiler$1]").replace(/\002/gi,"[/spoiler]");return t}},{key:"unparse",value:function e(t,i){var n="";for(var r=0;r<i.node.childNodes.length;r++){n+=this.htmlEditor.bbParser.GetNodeHtml(i.node.childNodes[r])}n=n.trim();if(n!==""){return"[SPOILER"+(i.node.hasAttribute("title")?"="+i.node.getAttribute("title"):"")+"]"+n+"[/SPOILER]"}return""}}]);return t}(a);var s=function(e){babelHelpers.inherits(i,e);function i(e,n){var r;babelHelpers.classCallCheck(this,i);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"id","postuser");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"buttonParams",null);t.EventEmitter.subscribe(n,"OnIframeKeydown",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(window.onKeyDownHandler){window.onKeyDownHandler(i,n,n.formID)}}));t.EventEmitter.subscribe(n,"OnIframeKeyup",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(window.onKeyUpHandler){window.onKeyUpHandler(i,n,n.formID)}}));t.EventEmitter.subscribe(n,"OnIframeClick",(function(){if(window["BXfpdStopMent"+n.formID]){window["BXfpdStopMent"+n.formID]()}}));t.EventEmitter.subscribe(n,"OnTextareaKeyup",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(n.textareaView&&n.textareaView.GetCursorPosition&&window.onTextareaKeyUpHandler){window.onTextareaKeyUpHandler(i,n,n.formID)}}));t.EventEmitter.subscribe(n,"OnTextareaKeydown",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];if(n.textareaView&&n.textareaView.GetCursorPosition&&window.onTextareaKeyDownHandler){window.onTextareaKeyDownHandler(i,n,n.formID)}}));return r}babelHelpers.createClass(i,[{key:"parse",value:function e(t,i){var n=this;t=t.replace(/\[USER\s*=\s*(\d+)\](.*?)\[\/USER\]/gi,(function(e,t,i){i=i.trim();if(i===""){return""}var r=n.htmlEditor.SetBxTag(false,{tag:n.id,userId:t,userName:i});return'<span id="'.concat(r,'" class="bxhtmled-metion">').concat(i,"</span>")})).replace(/\[PROJECT\s*=\s*(\d+)\](.*?)\[\/PROJECT\]/gi,(function(e,t,i){i=i.trim();if(i===""){return""}var r=n.htmlEditor.SetBxTag(false,{tag:n.id,projectId:t,projectName:i});return'<span id="'.concat(r,'" class="bxhtmled-metion">').concat(i,"</span>")})).replace(/\[DEPARTMENT\s*=\s*(\d+)\](.*?)\[\/DEPARTMENT\]/gi,(function(e,t,i){i=i.trim();if(i===""){return""}var r=n.htmlEditor.SetBxTag(false,{tag:n.id,departmentId:t,departmentName:i});return'<span id="'.concat(r,'" class="bxhtmled-metion">').concat(i,"</span>")}));return t}},{key:"unparse",value:function e(t,i){var n=this;var a="";i.node.childNodes.forEach((function(e){a+=n.htmlEditor.bbParser.GetNodeHtml(e)}));a=String(a).trim();var o="";if(r.Type.isStringFilled(a)){if(!r.Type.isUndefined(t.userId)){o="[USER=".concat(t.userId,"]").concat(a,"[/USER]")}else if(!r.Type.isUndefined(t.projectId)){o="[PROJECT=".concat(t.projectId,"]").concat(a,"[/PROJECT]")}else if(!r.Type.isUndefined(t.departmentId)){o="[DEPARTMENT=".concat(t.departmentId,"]").concat(a,"[/DEPARTMENT]")}}return o}}]);return i}(a);var l=function(){function e(i,n,r){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"actionPool",[]);this.cid=i;this.container=n;this.editor=r;t.EventEmitter.subscribe(r.getEventObject(),"onShowControllers",(function(e){var i=e.data;t.EventEmitter.emit(n.parentNode,"BFileDLoadFormController",new t.BaseEvent({compatData:[i]}))}));t.EventEmitter.subscribe(r.getEventObject(),"onCollectControllers",(function(e){e.data[i]={values:[]}}))}babelHelpers.createClass(e,[{key:"exec",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t){this.actionPool.push(t)}if(this.isReady){try{var i;while((i=this.actionPool.shift())&&i){i.apply(this)}}catch(e){console.log("error in attachments controllers: ",e)}}}},{key:"getId",value:function e(){return this.cid}},{key:"getFieldName",value:function e(){return null}},{key:"reinitFrom",value:function e(t){var i=this;this.exec((function(){if(!i.getFieldName()){return}i.container.querySelector('inptut[name="'.concat(i.getFieldName(),'"]')).forEach((function(e){e.parentNode.removeChild(e)}))}))}},{key:"isReady",get:function e(){return true}}]);return e}();var d=function(e){babelHelpers.inherits(i,e);function i(e,n,r){var a;babelHelpers.classCallCheck(this,i);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n,r));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"diskUfUploader",null);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"diskUfHandler",null);var o=function e(i){a.diskUfUploader=i;a.exec();var n=function e(i){t.EventEmitter.emit(r.getEventObject(),"onUploadsHasBeenChanged",i)};t.EventEmitter.subscribe(a.diskUfUploader,"onFileIsInited",n);t.EventEmitter.subscribe(a.diskUfUploader,"ChangeFileInput",n)};if(BX.UploaderManager.getById(e)){o(BX.UploaderManager.getById(e))}t.EventEmitter.subscribeOnce(n.parentNode,"DiskDLoadFormControllerInit",(function(t){var i=babelHelpers.slicedToArray(t.compatData,1),n=i[0];a.diskUfHandler=n;if(e===n.CID&&!a.diskUfUploader){o(n.agent)}}));t.EventEmitter.subscribe(r.getEventObject(),"onShowControllers",(function(e){var i=e.data;t.EventEmitter.emit(n.parentNode,"DiskLoadFormController",new t.BaseEvent({compatData:[i]}))}));return a}babelHelpers.createClass(i,[{key:"getFieldName",value:function e(){if(this.diskUfHandler){return this.diskUfHandler.params.controlName}return null}},{key:"reinitFrom",value:function e(t){var i=this;this.exec((function(){if(!i.getFieldName()){return}Array.from(i.container.querySelectorAll('inptut[name="'.concat(i.getFieldName(),'"]'))).forEach((function(e){e.parentNode.removeChild(e)}));var e=null;for(var n in t){if(t.hasOwnProperty(n)&&t[n]&&t[n]["USER_TYPE_ID"]==="disk_file"&&t[n]["FIELD_NAME"]===i.getFieldName()){e=t[n]["VALUE"]}}if(e){var r={};e.forEach((function(e){var t=document.querySelector("#disk-attach-"+e);if(t.tagName!=="A"){t=t.querySelector("img")}if(t){r["E"+e]={type:"file",id:e,name:t.getAttribute("data-bx-title")||t.getAttribute("data-title"),size:t.getAttribute("data-bx-size")||"",sizeInt:t.getAttribute("data-bx-size")||"",width:t.getAttribute("data-bx-width"),height:t.getAttribute("data-bx-height"),storage:"disk",previewUrl:t.tagName==="A"?"":t.getAttribute("data-bx-src")||t.getAttribute("data-src"),fileId:t.getAttribute("bx-attach-file-id")};if(t.hasAttribute("bx-attach-xml-id"))r["E"+e]["xmlId"]=t.getAttribute("bx-attach-xml-id");if(t.hasAttribute("bx-attach-file-type"))r["E"+e]["fileType"]=t.getAttribute("bx-attach-file-type")}}));i.diskUfHandler.selectFile({},{},r)}}))}},{key:"isReady",get:function e(){return!!this.diskUfUploader}}]);return i}(l);var c;var u=function(e){babelHelpers.inherits(i,e);function i(e,n){var a;babelHelpers.classCallCheck(this,i);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"id","uploadfile");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"buttonParams",null);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"regexp",/\[FILE ID=((?:\s|\S)*?)?\]/gi);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"values",new Map);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"controllers",new Map);a.checkButtonsDebounced=r.Runtime.debounce(a.checkButtons,500,babelHelpers.assertThisInitialized(a));a.init();t.EventEmitter.subscribe(e.getEditor(),"OnContentChanged",a.checkButtons.bind(babelHelpers.assertThisInitialized(a)));t.EventEmitter.subscribe(e.getEventObject(),"onReinitializeBefore",(function(e){var t=babelHelpers.slicedToArray(e.data,2),i=t[0],n=t[1];a.reinit(i,n)}));return a}babelHelpers.createClass(i,[{key:"init",value:function e(){var i=this;Array.from(this.editor.getContainer().querySelectorAll(".file-selectdialog")).forEach((function(e,n){var r=e.id.replace("file-selectdialog-","");var a=i.controllers.get(r);if(!a){a=new l(r,e,i.editor);t.EventEmitter.subscribe(e.parentNode,"OnFileUploadSuccess",(function(t){var n=babelHelpers.slicedToArray(t.data,2),a=n[0].element_id,o=n[1],s=o.id,l=o.doc_prefix,d=o.CID;if(r===s){var c=document.querySelector("#"+i.editor.getFormId())?document.querySelector("#"+i.editor.getFormId()).querySelector("#upload-cid"):null;if(c){c.value=d}var u=i.parseFile(e.querySelector("#"+l+a)),f=babelHelpers.slicedToArray(u,2),p=f[0],h=f[1];i.values.set(p,h)}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadRemove",(function(e){var t=babelHelpers.slicedToArray(e.compatData,2),n=t[0],a=t[1].id;if(r===a&&i.values.has(n)){i.values["delete"](n);i.deleteFile([n])}}));if(n===0){t.EventEmitter.subscribe(i.editor.getEventObject(),"onFilesHaveCaught",(function(e){e.stopImmediatePropagation();if(window["BfileFD"+r]){window["BfileFD"+r].agent.UploadDroppedFiles(babelHelpers.toConsumableArray(e.getData()))}}))}}if(e.querySelector("table.files-list")){Array.from(e.querySelector("table.files-list").querySelectorAll("tr")).forEach((function(e){var t=i.parseFile(e),n=babelHelpers.slicedToArray(t,2),r=n[0],a=n[1];i.values.set(r,a)}))}}))}},{key:"parseFile",value:function e(t){var i=this;var n=t.id.replace("wd-doc","");var a={id:n,name:t.querySelector('[data-role="name"]')?t.querySelector('[data-role="name"]').innerHTML:t.querySelector("span.f-wrap").innerHTML,node:t,buttonNode:t.querySelector('[data-role="button-insert"]'),image:{src:null,lowsrc:null,width:null,height:null}};var o=function e(){i.insertFile(n,t)};var s=t.querySelector(".f-wrap");if(s){s.addEventListener("click",o);s.style.cursor="pointer";s.title=r.Loc.getMessage("MPF_FILE")}var l=t.querySelector("img");if(l){l.addEventListener("click",o);l.title=r.Loc.getMessage("MPF_FILE");l.style.cursor="pointer";a.image.lowsrc=l.lowsrc||l.src;a.image.src=l.rel||l.src;a.image.width=l.getAttribute("data-bx-full-width");a.image.height=l.getAttribute("data-bx-full-height")}if(t instanceof HTMLTableRowElement&&t.querySelector(".files-info")){if(!a.buttonNode){a.buttonNode=r.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n<span type="button" onclick="','" data-role="button-insert" class="insert-btn">\n\t<span data-role="insert-btn" class="insert-btn-text">','</span>\n\t<span data-role="in-text-btn" class="insert-btn-text">',"</span>\n</span>"])),o,r.Loc.getMessage("MPF_FILE_INSERT_IN_TEXT"),r.Loc.getMessage("MPF_FILE_IN_TEXT"));t.querySelector(".files-info").appendChild(a.buttonNode);this.checkButtonsDebounced()}}return[n,a]}},{key:"buildHTML",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var r=this.htmlEditor.SetBxTag(false,{tag:this.id,fileId:t});var a='<span data-bx-file-id="'.concat(t,'" id="').concat(r,'" style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;">').concat(i.name,"</span>");if(i.image.src){var o=[];if(n){o.push('style="width:'.concat(n.width,"px;height:").concat(n.height,'px;"'))}else if(i.image.width&&i.image.height){o.push('style="width:'.concat(i.image.width,"px;height:").concat(i.image.height,'px;" '));o.push("onload=\"this.style.width='auto';this.style.height='auto';\"")}a='<img style="max-width: 90%;"  data-bx-file-id="'.concat(t,'" id="').concat(r,'" src="').concat(i.image.src,'" lowsrc="').concat(i.image.lowsrc,'" ').concat(o.join(" "),"/>")}return a}},{key:"buildText",value:function e(t,i){return"[FILE ID=".concat(t).concat(i||"","]")}},{key:"insertFile",value:function e(i,n){var r=this.values.get(String(i));if(r){t.EventEmitter.emit(this.editor.getEventObject(),"OnInsertContent",[this.buildText(i),this.buildHTML(i,r)])}}},{key:"deleteFile",value:function e(t){var i=this.htmlEditor.GetContent();if(this.htmlEditor.GetViewMode()==="wysiwyg"){var n=this.htmlEditor.GetIframeDoc();for(var r in this.htmlEditor.bxTags){if(this.htmlEditor.bxTags.hasOwnProperty(r)&&babelHelpers["typeof"](this.htmlEditor.bxTags[r])==="object"&&this.htmlEditor.bxTags[r]["tag"]===this.id&&t.indexOf(String(this.htmlEditor.bxTags[r]["fileId"]))>=0&&n.getElementById(r)){var a=n.getElementById(r);a.parentNode.removeChild(a)}}this.htmlEditor.SaveContent()}else{var o=i.replace(this.regexp,(function(e,i){return t.indexOf(i)>=0?"":e}));this.htmlEditor.SetContent(o);this.htmlEditor.Focus()}}},{key:"checkButtons",value:function e(t){var i=t?t.compatData[0]:this.htmlEditor.GetContent();var n=babelHelpers.toConsumableArray(i.matchAll(this.regexp)).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return n}));this.values.forEach((function(e,t){if(!e.buttonNode){return}var i=n.indexOf(t)>=0;if(i===true&&e.buttonNode.className!=="insert-text"){e.buttonNode.className="insert-text";e.buttonNode.querySelector('[data-role="insert-btn"]').style.display="none";e.buttonNode.querySelector('[data-role="in-text-btn"]').style.display=""}else if(i!==true&&e.buttonNode.className!=="insert-btn"){e.buttonNode.className="insert-btn";e.buttonNode.querySelector('[data-role="insert-btn"]').style.display="";e.buttonNode.querySelector('[data-role="in-text-btn"]').style.display="none"}}))}},{key:"reinit",value:function e(t,i){this.values.forEach((function(e,t){if(e.node&&e.node.parentNode){e.node.parentNode.removeChild(e.node)}}));this.values.clear();this.controllers.forEach((function(e){e.reinitFrom(i)}))}},{key:"parse",value:function e(t){if(!this.regexp.test(t)){return t}t=t.replace(this.regexp,function(e,t,i,n){if(this.values.has(t)){return this.buildHTML(t,this.values.get(t),i>0&&n>0?{width:i,height:n}:null)}return e}.bind(this));return t}},{key:"unparse",value:function e(t,i){var n=i.node;var r=parseInt(n.hasAttribute("width")?n.getAttribute("width"):0);var a=parseInt(n.hasAttribute("height")?n.getAttribute("height"):0);var o="";if(r>0&&a>0){o=" WIDTH="+r+" HEIGHT="+a}var s=n.getAttribute("data-bx-file-id");return this.buildText(s,o)}}]);return i}(a);var f=function(e){babelHelpers.inherits(i,e);function i(e,n){var r;babelHelpers.classCallCheck(this,i);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"id","uploadimage");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"buttonParams",null);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"regexp",/\[IMAGE ID=((?:\s|\S)*?)?\]/gi);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"values",new Map);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(r),"controllers",new Map);r.init();console.log("PostImage: ");t.EventEmitter.subscribe(e.getEventObject(),"onReinitializeBefore",(function(e){var t=babelHelpers.slicedToArray(e.data,2),i=t[0],n=t[1];r.reinit(i,n)}));return r}babelHelpers.createClass(i,[{key:"init",value:function e(){var i=this;Array.from(this.editor.getContainer().querySelectorAll(".file-selectdialog")).forEach((function(e){var n=e.id.replace("file-selectdialog-","");var r=i.controllers.get(n);if(!r){r=new l(n,e,i.editor);t.EventEmitter.subscribe(e.parentNode,"OnFileUploadSuccess",(function(t){var r=babelHelpers.slicedToArray(t.data,2),a=r[0].element_id,o=r[1],s=o.id,l=o.doc_prefix,d=o.CID;if(n===s){var c=document.querySelector("#"+i.editor.getFormId())?document.querySelector("#"+i.editor.getFormId()).querySelector("#upload-cid"):null;if(c){c.value=d}var u=i.parseFile(e.querySelector("#"+l+a)),f=babelHelpers.slicedToArray(u,2),p=f[0],h=f[1];i.values.set(p,h)}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadRemove",(function(e){var t=babelHelpers.slicedToArray(e.compatData,2),r=t[0],a=t[1].id;if(n===a&&i.values.has(r)){i.values["delete"](r)}}))}if(e.querySelector("table.files-list")){Array.from(e.querySelector("table.files-list").querySelectorAll("tr")).forEach((function(e){var t=i.parseFile(e),n=babelHelpers.slicedToArray(t,2),r=n[0],a=n[1];i.values.set(r,a)}))}}))}},{key:"parseFile",value:function e(t){var i=t.id.replace("wd-doc","");var n={id:i,name:t.querySelector('[data-role="name"]')?t.querySelector('[data-role="name"]').innerHTML:t.querySelector("span.f-wrap").innerHTML,node:t,image:{src:null,lowsrc:null,width:null,height:null}};return[i,n]}},{key:"reinit",value:function e(t,i){this.values.forEach((function(e,t){if(e.node&&e.node.parentNode){e.node.parentNode.removeChild(e.node)}}));this.values.clear();this.controllers.forEach((function(e){e.reinitFrom(i)}))}},{key:"parse",value:function e(t){return t}},{key:"unparse",value:function e(t,i){var n=i.node;return""}}]);return i}(a);var p;var h=function(e){babelHelpers.inherits(i,e);function i(){var e;var t;babelHelpers.classCallCheck(this,i);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++){r[a]=arguments[a]}t=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(i)).call.apply(e,[this].concat(r)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"id","diskfile");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"regexp",/\[(?:DOCUMENT ID|DISK FILE ID)=([n0-9]+)\]/gi);return t}babelHelpers.createClass(i,[{key:"init",value:function e(){var i=this;Array.from(this.editor.getContainer().querySelectorAll(".diskuf-selectdialog")).forEach((function(e,n){var r=e.id.replace("diskuf-selectdialog-","");var a=i.controllers.get(r);if(!a){a=new d(r,e,i.editor);i.controllers.set(r,a);t.EventEmitter.subscribe(e.parentNode,"OnFileUploadSuccess",(function(t){var n=babelHelpers.slicedToArray(t.data,3),r=n[0].element_id,o=n[1].CID,s=n[2];if(a.getId()!==o||i.values.has(r)){return}var l=i.parseFile(e.querySelector("#disk-edit-attach"+r)),d=babelHelpers.slicedToArray(l,3),c=d[0],u=d[1],f=d[2];i.values.set(c,f);if(c!==u){i.values.set(u,f)}if(s&&s["insertImageAfterUpload"]&&f.image.src){i.insertFile(c,f.node)}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadRemove",(function(e){var t=babelHelpers.slicedToArray(e.compatData,2),n=t[0],r=t[1].CID;if(a.getId()===r&&i.values.has(n)){var o=i.values.get(n);i.values["delete"](o.id);i.values["delete"](o.fileId);i.deleteFile([o.id,o.fileId])}}));t.EventEmitter.subscribe(e.parentNode,"OnFileUploadFailed",(function(e){var t=babelHelpers.slicedToArray(e.compatData,3),n=t[0],r=t[1].CID,o=t[2];if(a.getId()===r&&o&&o["referrerToEditor"]){BX.onCustomEvent(o["referrerToEditor"],"OnImageDataUriCaughtFailed",[]);BX.onCustomEvent(i.editor,"OnImageDataUriCaughtFailed",[o["referrerToEditor"]])}}));if(n===0){b(i,a,e,i.editor);m(i,a,e,i.editor);t.EventEmitter.subscribe(i.editor.getEventObject(),"onFilesHaveCaught",(function(e){e.stopImmediatePropagation();a.diskUfUploader.onChange(babelHelpers.toConsumableArray(e.getData()))}))}}if(e.querySelector("table.files-list")){Array.from(e.querySelector("table.files-list").querySelectorAll("tr")).forEach((function(e){var t=i.parseFile(e),n=babelHelpers.slicedToArray(t,3),r=n[0],a=n[1],o=n[2];i.values.set(r,o);if(r!==a){i.values.set(a,o)}}))}}))}},{key:"parseFile",value:function e(t){var i=this;var n=String(t.id.replace("disk-edit-attach",""));var a={id:n,name:t.querySelector('[data-role="name"]')?t.querySelector('[data-role="name"]').innerHTML:t.querySelector("span.f-wrap").innerHTML,fileId:t.getAttribute("bx-attach-file-id"),node:t,buttonNode:t.querySelector('[data-role="button-insert"]'),image:{src:null,lowsrc:null,width:null,height:null}};var o=t.querySelector(".f-wrap");var s=function e(){i.insertFile(n,t)};if(o){o.addEventListener("click",s);o.style.cursor="pointer";o.title=r.Loc.getMessage("MPF_FILE")}var l=t.querySelector("img.files-preview");if(l&&(l.src.indexOf("bitrix/tools/disk/uf.php")>=0||l.src.indexOf("/disk/showFile/")>=0)){l.addEventListener("click",s);l.title=r.Loc.getMessage("MPF_FILE");l.style.cursor="pointer";a.image.lowsrc=l.lowsrc||l.src;a.image.src=(l.rel||l.getAttribute("data-bx-src")||l.src).replace(/&(width|height)=\d+/gi,"");var d=function e(){a.image.width=l.getAttribute("data-bx-full-width");a.image.height=l.getAttribute("data-bx-full-height")};l.addEventListener("load",d);if(l.complete){d()}}if(t instanceof HTMLTableRowElement&&!a.buttonNode){a.buttonNode=r.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n<span class="insert-btn" data-role="button-insert" onclick="','">\n\t<span data-role="insert-btn" class="insert-btn-text">','</span>\n\t<span data-role="in-text-btn" class="insert-btn-text" style="display: none;">',"</span>\n</span>"])),s,r.Loc.getMessage("MPF_FILE_INSERT_IN_TEXT"),r.Loc.getMessage("MPF_FILE_IN_TEXT"));setTimeout((function(){if(t.querySelector(".files-info")){t.querySelector(".files-info").appendChild(a.buttonNode);i.checkButtonsDebounced()}}))}return[n,a.fileId,a]}},{key:"buildText",value:function e(t,i){return"[DISK FILE ID=".concat(t).concat(i||"","]")}}]);return i}(u);function b(e,i,n,r){t.EventEmitter.subscribe(r.getEventObject(),"OnVideoHasCaught",(function(r){var a=r.getData();var o=function i(r){var o=babelHelpers.slicedToArray(r.data,3),s=o[0].element_id;babelHelpers.objectDestructuringEmpty(o[1]);var l=o[2];if(a===l&&e.values.has(s)){t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadSuccess",i);e.insertFile(s,e.values.get(s).node)}};t.EventEmitter.subscribe(n.parentNode,"OnFileUploadSuccess",o);i.exec((function(){i.diskUfUploader.onChange([a])}));r.stopImmediatePropagation()}))}function m(e,i,n,r){t.EventEmitter.subscribe(r.getEventObject(),"OnImageHasCaught",(function(r){r.stopImmediatePropagation();var a=r.getData();return new Promise((function(o,s){var l=function i(r){var s=babelHelpers.slicedToArray(r.data,3),l=s[0].element_id;babelHelpers.objectDestructuringEmpty(s[1]);var c=s[2];if(a===c&&e.values.has(l)){t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadSuccess",i);t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadFailed",d);var u=e.values.get(l);var f=e.buildHTML(l,u);o({image:u.image,html:f})}};var d=function e(i){var r=babelHelpers.slicedToArray(i.data,3),o=r[0];babelHelpers.objectDestructuringEmpty(r[1]);var d=r[2];if(a===d){t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadSuccess",l);t.EventEmitter.unsubscribe(n.parentNode,"OnFileUploadFailed",e);s()}};t.EventEmitter.subscribe(n.parentNode,"OnFileUploadSuccess",l);t.EventEmitter.subscribe(n.parentNode,"OnFileUploadFailed",d);i.exec((function(){i.diskUfUploader.onChange([r.getData()])}))}))}))}function v(e,t,i){if(e==="Spoiler"){return new o(t,i)}else if(e==="MentionUser"){return new s(t,i)}else if(e==="UploadImage"){return new f(t,i)}else if(e==="UploadFile"){return new u(t,i)}else if(babelHelpers["typeof"](e)==="object"&&e["disk_file"]){return new h(t,i)}return null}function E(e,t){if(!t){return}BX.addCustomEvent(t,"onAutoSavePrepare",(function(t){t.FORM.setAttribute("bx-lhe-autosave-prepared","Y");setTimeout((function(){BX.addCustomEvent(e,"OnContentChanged",(function(e){t["mpfTextContent"]=e;t.Init()}))}),1500)}));BX.addCustomEvent(t,"onAutoSave",(function(e,t){if(BX.type.isNotEmptyString(e["mpfTextContent"]))t["text"]=e["mpfTextContent"]}));BX.addCustomEvent(t,"onAutoSaveRestore",(function(t,i){if(i["text"]&&/[^\s]+/gi.test(i["text"])){e.CheckAndReInit(i["text"])}}));if(t.hasAttribute("bx-lhe-autosave-prepared")&&t.BXAUTOSAVE){t.removeAttribute("bx-lhe-autosave-prepared");setTimeout(t.BXAUTOSAVE.Prepare,100)}}function g(e,t,i){var n=false;if(i.showPanelEditor!==true&&i.showPanelEditor!==false){i.showPanelEditor=!t.toolbar.IsShown();n=true}e.exec((function(){var n=e.getContainer().querySelector('[data-bx-role="button-show-panel-editor"]');if(i.showPanelEditor){t.dom.toolbarCont.style.opacity="inherit";t.toolbar.Show();if(n){n.classList.add("feed-add-post-form-btn-active")}}else{t.toolbar.Hide();if(n){n.classList.remove("feed-add-post-form-btn-active")}}}));if(n!==false){BX.userOptions.save("main.post.form","postEdit","showBBCode",i.showPanelEditor?"Y":"N")}}function y(e,t){if(!(t.urlPreviewId&&window["BXUrlPreview"]&&BX(t.urlPreviewId))){return}var i=new BXUrlPreview(BX(t.urlPreviewId));var n=function e(t){i.attachUrlPreview({url:t})};var r=function e(t,n,r,a){if(n==="createLink"&&BX.type.isPlainObject(a)&&a.hasOwnProperty("href")){i.attachUrlPreview({url:a.href})}};BX.addCustomEvent(e,"OnAfterUrlConvert",n);BX.addCustomEvent(e,"OnAfterLinkInserted",n);BX.addCustomEvent(e,"OnBeforeCommandExec",r);BX.addCustomEvent(e,"OnReinitialize",(function(e,t){i.detachUrlPreview();var n;for(var r in t){if(t.hasOwnProperty(r)&&t[r].hasOwnProperty("USER_TYPE_ID")&&t[r]["USER_TYPE_ID"]==="url_preview"){n=t[r]["VALUE"];break}}if(n){i.attachUrlPreview({id:n})}}))}function w(e,t){e.exec((function(){t.contextMenu.items["postimage"]=t.contextMenu.items["postdocument"]=t.contextMenu.items["postfile"]=[{TEXT:r.Loc.getMessage("BXEdDelFromText"),bbMode:true,ACTION:function e(){var i=t.contextMenu.GetTargetItem("postimage");if(!i)i=t.contextMenu.GetTargetItem("postdocument");if(!i)i=t.contextMenu.GetTargetItem("postfile");if(i&&i.element){t.selection.RemoveNode(i.element)}t.contextMenu.Hide()}}];if(t.toolbar.controls&&t.toolbar.controls.FontSelector){t.toolbar.controls.FontSelector.SetWidth(45)}}))}function B(e){var i=document.querySelector("#lhe_button_submit_"+e.getFormId());if(i){i.addEventListener("click",(function(i){t.EventEmitter.emit(e.getEventObject(),"OnButtonClick",["submit"]);i.preventDefault();i.stopPropagation()}))}var n=document.querySelector("#lhe_button_cancel_"+e.getFormId());if(n){n.addEventListener("click",(function(i){t.EventEmitter.emit(e.getEventObject(),"OnButtonClick",["cancel"]);i.preventDefault();i.stopPropagation()}))}}function I(e,i){var n=e.getContainer().querySelector('[data-bx-role="toolbar"]');if(n.querySelector('[data-id="file"]')){var r=n.querySelector('[data-id="file"]');if(r){r.addEventListener("click",(function(){t.EventEmitter.emit(e.getEventObject(),"onShowControllers",r.hasAttribute("data-bx-button-status")?"hide":"show")}));t.EventEmitter.subscribe(e.getEventObject(),"onShowControllers",(function(e){var t=e.data;if(t.toString()==="show"){r.setAttribute("data-bx-button-status","active")}else{r.removeAttribute("data-bx-button-status")}}));r.setAttribute("data-bx-files-count",0);t.EventEmitter.subscribe(e.getEventObject(),"onShowControllers:File:Increment",(function(e){var t=e.data;var i=t>0?t:1;var n=Math.max(parseInt(r.getAttribute("data-bx-files-count")||0)+i,0);if(n>0){if(!r["counterObject"]){r["counterObject"]=new BX.UI.Counter({value:n,color:BX.UI.Counter.Color.GRAY,animate:true});var a=r.querySelector("span");a.appendChild(r["counterObject"].getContainer())}else{r["counterObject"].update(n)}}r.setAttribute("data-bx-files-count",n)}));t.EventEmitter.subscribe(e.getEventObject(),"onShowControllers:File:Decrement",(function(e){var t=e.data;var i=t>0?t:1;var n=Math.max(parseInt(r.getAttribute("data-bx-files-count")||0)-i,0);r.setAttribute("data-bx-files-count",n);if(r["counterObject"]){r["counterObject"].update(n)}}))}}if(n.querySelector('[data-id="search-tag"]')){window["BXPostFormTags_"+e.getFormId()]=new BXPostFormTags(e.getFormId(),n.querySelector('[data-id="search-tag"]'))}if(n.querySelector('[data-id="create-link"]')){n.querySelector('[data-id="create-link"]').addEventListener("click",(function(e){i.toolbar.controls.InsertLink.OnClick(e)}))}if(n.querySelector('[data-id="video"]')){n.querySelector('[data-id="video"]').addEventListener("click",(function(e){i.toolbar.controls.InsertVideo.OnClick(e)}))}if(n.querySelector('[data-id="quote"]')){var a=n.querySelector('[data-id="quote"]');a.setAttribute("data-bx-type","action");a.setAttribute("data-bx-action","quote");a.addEventListener("mousedown",(function(e){i.toolbar.controls.Quote.OnMouseDown.apply(i.toolbar.controls.Quote,[e]);i.CheckCommand(a)}))}if(e.getContainer().querySelector('[data-bx-role="button-show-panel-editor"]')){e.getContainer().querySelector('[data-bx-role="button-show-panel-editor"]').addEventListener("click",(function(){e.showPanelEditor()}))}}var S;var C;function T(e,t){if(!C){C=new IntersectionObserver((function(e){e.forEach((function(e){if(e.isIntersecting){C.unobserve(e.target);var t=e.target.observedCallback;delete e.target.observedCallback;setTimeout(t)}}))}),{threshold:0})}e.observedCallback=t;C.observe(e)}var P=0;var O=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.container=i.querySelector('[data-bx-role="toolbar"]');this.adjustMorePosition=this.adjustMorePosition.bind(this);this.moreItem=i.querySelector('[data-bx-role="toolbar-item-more"]');this.moreItem.addEventListener("click",this.showSubmenu.bind(this));T(this.container,this.adjustMorePosition);window.addEventListener("resize",this.adjustMorePosition)}babelHelpers.createClass(e,[{key:"insertAfter",value:function e(t,i){if(!r.Type.isElementNode(t["BODY"])&&!r.Type.isStringFilled(t["BODY"])){return}var n=r.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="main-post-form-toolbar-button" data-bx-role="toolbar-item"></div>'])));if(r.Type.isElementNode(t["BODY"])){n.appendChild(t["BODY"])}else{n.innerHTML=t["BODY"]}if(t["ID"]){n.setAttribute("data-id",t["ID"])}if(i!==null){var a=false;var o=null;Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){if(a===true&&o===null){o=e}else if(a===false&&e&&e.dataset&&e.dataset.id===i){a=true}}));if(o){o.parentNode.insertBefore(n,o)}}if(!n.parentNode){this.container.appendChild(n)}this.adjustMorePosition()}},{key:"getItems",value:function e(){return Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]'))}},{key:"getVisibleItems",value:function e(){var t=this;var i=[];Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){if(e.offsetTop>t.container.clientHeight/2){i.push(e)}}));return i}},{key:"getHiddenItems",value:function e(){var t=[];Array.from(this.container.querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){if(e.offsetTop>0){t.push(e)}}));return t}},{key:"adjustMorePosition",value:function e(){var t=this.getVisibleItems().length;if(t<=0||t>=this.getItems().length){this.moreItem.style.display="none"}else{this.moreItem.style.display=""}}},{key:"getPopup",value:function e(){var t=this;if(!this.popup){this.popup=n.PopupManager.create({id:"main_post_form_toolbar_"+P++,className:"main-post-form-toolbar-popup",cacheable:false,content:this.getPopupContainer(),closeByEsc:true,autoHide:true,angle:true,bindElement:this.moreItem,offsetTop:-5,offsetLeft:5,events:{onClose:function e(){Array.from(t.getPopupContainer().querySelectorAll('[data-bx-role="toolbar-item"]')).forEach((function(e){t.container.appendChild(e)}));delete t.popup}}})}return this.popup}},{key:"getPopupContainer",value:function e(){if(!this.popupContainer){this.popupContainer=document.createElement("DIV")}return this.popupContainer}},{key:"showSubmenu",value:function e(){var t=this;var i=this.getHiddenItems();if(i.length<=0){return}i.forEach((function(e){t.getPopupContainer().appendChild(e)}));this.getPopup().show()}}]);return e}();var x=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"showPopup",value:function e(t){var i=n.PopupManager.getPopupById(this.getPopupId());if(!i){i=new n.Popup(this.getPopupId(),null,{content:this.getTasksLimitPopupContent(),lightShadow:false,offsetLeft:20,autoHide:false,angle:{position:"bottom"},closeByEsc:false,closeIcon:true})}i.setBindElement(t.bindPosition);i.show()}},{key:"getPopupId",value:function e(){return"bx-post-mention-tasks-limit-popup"}},{key:"getTasksLimitPopupContent",value:function e(){return r.Dom.create("DIV",{style:{width:"400px",padding:"10px"},children:[r.Dom.create("SPAN",{html:r.Loc.getMessage("MPF_MENTION_TASKS_LIMIT").replace("#A_BEGIN#",'<a href="javascript:void(0);" onclick="BX.Main.PostFormTasksLimit.onClickTasksLimitPopupSlider();">').replace("#A_END#","</a>")})]})}},{key:"onClickTasksLimitPopupSlider",value:function e(){this.hidePopup();BX.UI.InfoHelper.show("limit_tasks_observers_participants",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"postForm",subject:"auditor"}})}},{key:"hidePopup",value:function e(){var t=n.PopupManager.getPopupById(this.getPopupId());if(t){t.close()}}}]);return e}();function X(e,t,i){H(e,t);k(i,"get");return F(e,i)}function k(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function H(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function F(e,t){if(t.get){return t.get.call(e)}return t.value}var A=function(){function e(i,n){var a=this;babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"jobs",new Map);babelHelpers.defineProperty(this,"editorParams",{height:100,ctrlEnterHandler:null,parsers:null,showPanelEditor:false,lazyLoad:true,urlPreviewId:null,tasksLimitExceeded:false});babelHelpers.defineProperty(this,"actionQueue",[]);this.id=i["id"];this.name=i["name"];this.formId=i["formId"];this.eventNode=i.eventNode||document.querySelector("#div"+(this.name||this.id));this.eventNode.dataset.bxHtmlEditable="Y";this.formEntityType=null;e.repo.set(this.getId(),this);if(!r.Type.isArray(n.parsers)&&r.Type.isPlainObject(n.parsers)){n.parsers=Object.values(n.parsers)}this.setEditorParams(n);this.bindEvents(window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(this.getId()):null);this.toolbar=new O(this.getEventObject(),this.getContainer());this.inited=true;if(this.name!==null){window[this.name]=this}BX.onCustomEvent(this,"onInitialized",[this,this.getFormId()]);t.EventEmitter.subscribe(this.getEventObject(),"OnFileUploadSuccess",(function(e){var t=e.compatData;BX.onCustomEvent(a.getEventObject(),"onFileIsAdded",t)}));t.EventEmitter.subscribe(this.getEventObject(),"onBusy",(function(e){var i=e.data;if(a.jobs.size<=0){t.EventEmitter.emit(a.getEventObject(),"onLHEIsBusy")}a.jobs.set(i,(a.jobs.get(i)||0)+1)}));t.EventEmitter.subscribe(this.getEventObject(),"onReady",(function(e){var i=e.data;if(a.jobs.size<=0||!a.jobs.has(i)){return}var n=a.jobs.get(i);if(n<=1){a.jobs["delete"](i);if(a.jobs.size<=0){t.EventEmitter.emit(a.getEventObject(),"onLHEIsReady")}}else{a.jobs.set(i,--n)}}))}babelHelpers.createClass(e,[{key:"setEditorParams",value:function e(t){this.editorParams=Object.assign(this.editorParams,t)}},{key:"bindEvents",value:function e(){var i=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.events={};[["OnEditorInitedBefore",this.OnEditorInitedBefore.bind(this)],["OnCreateIframeAfter",this.OnCreateIframeAfter.bind(this)],["OnEditorInitedAfter",this.OnEditorInitedAfter.bind(this)]].forEach((function(e){var t=babelHelpers.slicedToArray(e,2),r=t[0],a=t[1];if(!n){i.events[r]=function(e){if(e.id===i.getId()){
//!it important to use deprecated eventEmitter
BX.removeCustomEvent(r,i.events[r]);delete i.events[r];a(e)}};//!it important to use deprecated eventEmitter
BX.addCustomEvent(r,i.events[r])}else{a(n)}}));t.EventEmitter.subscribe(this.getEventObject(),"OnShowLHE",this.OnShowLHE.bind(this));t.EventEmitter.subscribe(this.getEventObject(),"OnButtonClick",this.OnButtonClick.bind(this));t.EventEmitter.subscribe(this.getEventObject(),"OnParserRegister",(function(e){var t=e.data;i.addParser(t)}));t.EventEmitter.subscribe(this.getEventObject(),"OnGetHTMLEditor",(function(e){var t=e.data;t.htmlEditor=i.getEditor()}));t.EventEmitter.subscribe(this.getEventObject(),"OnInsertContent",(function(e){var t=babelHelpers.slicedToArray(e.data,2),n=t[0],r=t[1];i.insertContent(n,r)}));t.EventEmitter.subscribe(this.getEventObject(),"OnAddButton",(function(e){var t=babelHelpers.slicedToArray(e.data,2),n=t[0],r=t[1];i.getToolbar().insertAfter(n,r)}));B(this)}},{key:"getId",value:function e(){return this.id}},{key:"setEditor",value:function i(n){var a=this;if(this.htmlEditor===n){return}this.htmlEditor=n;n.formID=this.getFormId();t.EventEmitter.subscribe(n,"OnCtrlEnter",(function(){n.SaveContent();if(r.Type.isFunction(a.editorParams.ctrlEnterHandler)){a.editorParams.ctrlEnterHandler()}else if(r.Type.isStringFilled(a.editorParams.ctrlEnterHandler)&&window[a.editorParams.ctrlEnterHandler]){window[a.editorParams.ctrlEnterHandler]()}else if(document.forms[a.getFormId()]){BX.submit(document.forms[a.getFormId()])}}));this.editorParams["height"]=n.config["height"];console.groupCollapsed("main.post.form: parsers: ",this.getId());this.editorParams.parsers.forEach((function(e){var t=v(e,a,n);if(t){console.groupCollapsed(e);console.log(t);if(t.hasButton()){n.AddButton(t.getButton())}n.AddParser(t.getParser());console.groupEnd(e)}}));console.groupEnd("main.post.form: parsers: ",this.getId());t.EventEmitter.subscribe(n,"OnImageDataUriHandle",(function(e){var i=babelHelpers.slicedToArray(e.compatData,2),r=i[0],o=i[1];var s=BX.UploaderUtils.dataURLToBlob(o.src);if(s&&s.size>0&&s.type.indexOf("image/")===0){t.EventEmitter.emit(a.getEventObject(),"onShowControllers","show");s.name=s.name||o.title||"image."+s.type.substr(6);s.referrerToEditor=o;t.EventEmitter.emit(a.getEventObject(),"OnImageHasCaught",new t.BaseEvent({data:s})).forEach((function(e){e.then((function(e){var i=e.image,r=e.html;t.EventEmitter.emit(n,"OnImageDataUriCaughtUploaded",new t.BaseEvent({compatData:[o,i,{replacement:r}]}))}))["catch"]((function(){t.EventEmitter.emit(n,"OnImageDataUriCaughtFailed",new t.BaseEvent({compatData:[o]}))}))}))}}));t.EventEmitter.subscribe(t.EventEmitter.GLOBAL_TARGET,"onAddVideoMessage",(function(e){var i=babelHelpers.slicedToArray(e.compatData,2),n=i[0],r=i[1];if(!r||a.getFormId()!==r){return}t.EventEmitter.emit(a.getEventObject(),"onShowControllers","show");t.EventEmitter.emit(a.getEventObject(),"OnVideoHasCaught",new t.BaseEvent({data:n}))}));(function(){var i=BX("micro"+(a.name||a.id));var n=false;var r=0;var o=function e(t){t.preventDefault();t.stopPropagation();if(r>0){clearTimeout(r);r=0}if(n===true){return}var o=t&&t["dataTransfer"]&&t["dataTransfer"]["types"]&&t["dataTransfer"]["types"].indexOf("Files")>=0;if(o){n=true;a.getContainer().classList.add("feed-add-post-dnd-over");if(i){i.classList.add("feed-add-post-micro-dnd-ready")}}return true};var s=function e(t){t.preventDefault();t.stopPropagation();if(r>0){clearTimeout(r)}r=setTimeout((function(){n=false;a.getContainer().classList.remove("feed-add-post-dnd-over");if(i){i.classList.remove("feed-add-post-micro-dnd-ready")}}),100);return false};var l=function e(i){s(i);if(i&&i["dataTransfer"]&&i["dataTransfer"]["types"]&&i["dataTransfer"]["types"].indexOf("Files")>=0&&i["dataTransfer"]["files"]&&i["dataTransfer"]["files"].length>0){t.EventEmitter.emit(a.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",{onShowControllers:"show"}]}));t.EventEmitter.emit(a.getEventObject(),"onFilesHaveCaught",new t.BaseEvent({data:i["dataTransfer"]["files"]}))}return false};a.getContainer().addEventListener("dragover",o);a.getContainer().addEventListener("dragenter",o);a.getContainer().addEventListener("dragleave",s);a.getContainer().addEventListener("dragexit",s);a.getContainer().addEventListener("drop",l);a.getContainer().setAttribute("dropzone","copy f:*/*");if(!document.body.hasAttribute("dropzone")){document.body.setAttribute("dropzone","copy f:*/*");document.body.addEventListener("dragover",(function(e){e.preventDefault();e.stopPropagation();return true}));document.body.addEventListener("drop",function(i){i.preventDefault();i.stopPropagation();if(i&&i["dataTransfer"]&&i["dataTransfer"]["types"]&&i["dataTransfer"]["types"].indexOf("Files")>=0&&i["dataTransfer"]["files"]&&i["dataTransfer"]["files"].length>0){var n;var r;var a=X(this.constructor,e,D).keys();while((r=a.next())&&r.done!==true&&r.value){n=r.value}if(n){t.EventEmitter.emit(n.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",{onShowControllers:"show"}]}));t.EventEmitter.emit(n.getEventObject(),"onFilesHaveCaught",new t.BaseEvent({data:i["dataTransfer"]["files"]}))}}return false}.bind(a))}if(i){i.addEventListener("dragenter",(function(e){o(e);t.EventEmitter.emit(a.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",{onShowControllers:"show"}]}))}))}t.EventEmitter.subscribe(a.getEditor(),"OnIframeDrop",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];return l(i)}));t.EventEmitter.subscribe(a.getEditor(),"OnIframeDragOver",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];return o(i)}));t.EventEmitter.subscribe(a.getEditor(),"OnIframeDragLeave",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];return s(i)}))})();t.EventEmitter.subscribe(n,"OnInsertContent",(function(e){var t=babelHelpers.slicedToArray(e.data,2),i=t[0],n=t[1];a.insertContent(i,n)}));g(this,n,this.editorParams);y(n,this.editorParams);w(this,n);E(n,BX(this.getFormId()));I(this,n);t.EventEmitter.subscribe(this.getEventObject(),"OnAfterShowLHE",(function(){a.getEditor().AllowBeforeUnloadHandler()}));t.EventEmitter.subscribe(this.getEventObject(),"OnAfterHideLHE",(function(){x.hidePopup();a.getEditor().DenyBeforeUnloadHandler()}));t.EventEmitter.subscribe(n,"OnIframeClick",(function(){var e=new MouseEvent("click",{bubbles:true,cancelable:true,view:window});n.iframeView.container.dispatchEvent(e)}))}},{key:"getEditor",value:function e(){return this.htmlEditor}},{key:"getFormId",value:function e(){return this.formId}},{key:"getEventObject",value:function e(){return this.eventNode}},{key:"getContainer",value:function e(){return this.eventNode}},{key:"getToolbar",value:function e(){return this.toolbar}},{key:"OnEditorInitedBefore",value:function e(t){this.setEditor(t)}},{key:"OnCreateIframeAfter",value:function e(){if(this.editorIsLoaded!==true){this.editorIsLoaded=true;this.exec();t.EventEmitter.emit(this,"OnEditorIsLoaded",[])}}},{key:"OnEditorInitedAfter",value:function e(i){if(!this.editorParams.lazyLoad){t.EventEmitter.emit(this.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["justShow",i,false]}))}if(i.sandbox&&i.sandbox.inited){this.OnCreateIframeAfter()}}},{key:"addParser",value:function e(t){var i=this;this.exec((function(){t.init(i.getEditor());i.getEditor().AddParser({name:t.id,obj:{Parse:function e(i,n){return t.parse(n)},UnParse:t.unparse}});if(!i["addParserAfterDebounced"]){i.addParserAfterDebounced=r.Runtime.debounce((function(){i.getEditor().SetContent(i.getEditor().GetContent().replace(/&#91;/gi,"[").replace(/&#93;/gi,"]"),true)}),100)}i.addParserAfterDebounced()}))}},{key:"insertContent",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this.exec((function(){var e=i.getEditor().GetViewMode();if(e==="wysiwyg"){i.getEditor().InsertHtml(n||t);setTimeout(i.getEditor().AutoResizeSceleton.bind(i.getEditor()),500);setTimeout(i.getEditor().AutoResizeSceleton.bind(i.getEditor()),1e3)}else{i.getEditor().textareaView.Focus();if(!i.getEditor().bbCode){var r=i.getEditor().GetIframeDoc();var a=r.createElement("DIV");a.style.display="none";a.innerHTML=t;r.body.appendChild(a);t=i.getEditor().Parse(t,true,false);a.parentNode.removeChild(a)}i.getEditor().textareaView.WrapWith("","",t)}}))}},{key:"reinit",value:function e(i,n){var a="hide";if(r.Type.isPlainObject(n)&&Object.values(n).length){Object.values(n).forEach((function(e){if(e&&e["VALUE"]){a="show"}}))}t.EventEmitter.emit(this.getEventObject(),"onShowControllers",a);t.EventEmitter.emit(this.getEventObject(),"onReinitializeBefore",[i,n]);this.getEditor().CheckAndReInit(r.Type.isString(i)?i:"");BX.onCustomEvent(this.getEditor(),"onReinitialize",[this,i,n]);if(this.editorParams["height"]){this.oEditor.SetConfigHeight(this.editorParams["height"]);this.oEditor.ResizeSceleton()}}},{key:"OnShowLHE",value:function i(n){var a=this;var o=n.data,s=n.compatData;var l=o||s,d=babelHelpers.slicedToArray(l,3),c=d[0],u=d[1],f=d[2];if(!this.getEditor()&&window["BXHtmlEditor"]){window["BXHtmlEditor"].Get(this.getId()).Init()}c=c===false||c==="hide"||c==="justShow"?c:true;var p=BX("micro"+(this.name||this.id));if(p){p.style.display=c===true||c==="justShow"?"none":"block"}if(c==="hide"){X(this.constructor,e,D)["delete"](this);t.EventEmitter.emit(this.getEventObject(),"OnBeforeHideLHE");if(this.getContainer().style.display==="none"){t.EventEmitter.emit(this.getEventObject(),"OnAfterHideLHE");t.EventEmitter.emit(this.getEventObject(),"onShowControllers","hide")}else{new BX["easing"]({duration:200,start:{opacity:100,height:this.getContainer().scrollHeight},finish:{opacity:0,height:20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function e(t){a.getContainer().style.height=t.height+"px";a.getContainer().style.opacity=t.opacity/100},complete:function e(){a.getContainer().style.cssText="";a.getContainer().style.display="none";t.EventEmitter.emit(a.getEventObject(),"OnAfterHideLHE");t.EventEmitter.emit(a.getEventObject(),"onShowControllers","hide")}}).animate()}}else if(c){X(this.constructor,e,D).set(this);this.formEntityType=r.Type.isArray(f)&&r.Type.isStringFilled(f[0])&&f[0].match(/^TASK_(\d+)$/i)?"task":null;if(u&&r.Type.isPlainObject(u)){if(u["onShowControllers"]){t.EventEmitter.emit(this.getEventObject(),"onShowControllers",u["onShowControllers"])}}t.EventEmitter.emit(this.getEventObject(),"OnBeforeShowLHE");if(c==="justShow"||this.getContainer().style.display==="block"){this.getContainer().style.display="block";t.EventEmitter.emit(this.getEventObject(),"OnAfterShowLHE");if(u!==false){this.getEditor().Focus()}}else{r.Dom.adjust(this.getContainer(),{style:{display:"block",overflow:"hidden",height:"20px",opacity:.1}});new BX["easing"]({duration:200,start:{opacity:10,height:20},finish:{opacity:100,height:this.getContainer().scrollHeight},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function e(t){a.getContainer().style.height=t.height+"px";a.getContainer().style.opacity=t.opacity/100},complete:function e(){t.EventEmitter.emit(a.getEventObject(),"OnAfterShowLHE");a.getEditor().Focus();a.getContainer().style.cssText=""}}).animate()}}else{X(this.constructor,e,D)["delete"](this);t.EventEmitter.emit(this.getEventObject(),"OnBeforeHideLHE");t.EventEmitter.emit(this.getEventObject(),"onShowControllers","hide");this.getContainer().style.display="none";t.EventEmitter.emit(this.getEventObject(),"OnAfterHideLHE")}}},{key:"OnButtonClick",value:function e(i){var n=babelHelpers.slicedToArray(i.data,1),r=n[0];if(r!=="cancel"){var a={result:true};t.EventEmitter.emit(this.getEventObject(),"OnClickBeforeSubmit",new t.BaseEvent({compatData:[this,a]}));if(a["result"]!==false){t.EventEmitter.emit(this.getEventObject(),"OnClickSubmit",new t.BaseEvent({compatData:[this]}))}}else{t.EventEmitter.emit(this.getEventObject(),"OnClickCancel",new t.BaseEvent({compatData:[this]}));t.EventEmitter.emit(this.getEventObject(),"OnShowLHE",new t.BaseEvent({compatData:["hide"]}))}}},{key:"exec",value:function e(t,i){if(typeof t=="function"){this.actionQueue.push([t,i])}if(this.editorIsLoaded===true){var n;while((n=this.actionQueue.shift())&&n){n[0].apply(this,n[1])}}}},{key:"showPanelEditor",value:function e(){g(this,this.getEditor(),{})}},{key:"getContent",value:function e(){return this.oEditor?this.oEditor.GetContent():""}},{key:"setContent",value:function e(t){if(this.getEditor()){this.getEditor().SetContent(t)}}},{key:"controllerInit",value:function e(i){t.EventEmitter.emit(this.getEventObject(),"onShowControllers",i==="hide"?"hide":"show")}},{key:"isReady",get:function e(){return this.editorIsLoaded}},{key:"oEditor",get:function e(){return this.getEditor()}},{key:"oEditorId",get:function e(){return this.getId()}},{key:"formID",get:function e(){return this.getFormId()}},{key:"params",get:function e(){return{formID:this.getFormId()}}},{key:"controllers",get:function e(){var i=new t.BaseEvent;var n={};i.setData(n);t.EventEmitter.emit(this.getEventObject(),"onCollectControllers",i);var a={};Object.keys(n).forEach((function(e){a[e]=Object.assign({},n[e]);a[e]["values"]={};if(r.Type.isArray(n[e]["values"])){n[e]["values"].forEach((function(t){a[e]["values"][t]={id:t}}))}else if(r.Type.isPlainObject(n[e]["values"])){a[e]["values"]=Object.assign({},n[e]["values"])}}));return a}},{key:"arFiles",get:function e(){var i=new t.BaseEvent;var n={};i.setData(n);t.EventEmitter.emit(this.getEventObject(),"onCollectControllers",i);var r={};Object.keys(n).forEach((function(e){if(n[e]["values"]){n[e]["values"].forEach((function(t){r[t]=[e]}))}}));return r}}]);return e}();babelHelpers.defineProperty(A,"repo",new Map);var D={writable:true,value:new Map};window["LHEPostForm"]={getEditor:function e(t){return window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(babelHelpers["typeof"](t)=="object"?t.id:t):null},getHandler:function e(t){var i=r.Type.isStringFilled(t)?t:t.id;return A.repo.get(i)},getHandlerByFormId:function e(t){var i=null;A.repo.forEach((function(e){if(e.getFormId()===t){i=e}}));return i},reinitData:function e(t,i,n){var a={};if(!r.Type.isPlainObject(n)){n={}}Object.entries(n).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];if(r.Type.isPlainObject(n)&&n["USER_TYPE_ID"]&&n["VALUE"]&&Object.values(n["VALUE"]).length>0){a[i]=n}}));var o=this.getHandler(t);if(o&&(o.isReady||r.Type.isStringFilled(i)||Object.values(a).length>0)){o.exec(o.reinit,[i,a])}return false},reinitDataBefore:function e(i){var n=A.repo.get(i);if(n&&n.getEventObject()){t.EventEmitter.emit(n.getEventObject(),"onReinitializeBefore",[n])}}};e.PostForm=A;e.PostFormTasksLimit=x})(this.BX.Main=this.BX.Main||{},BX.Event,BX,BX.Main,BX);(function(){if(window["BXPostFormTags"])return;var e={selector:{},mentionParams:{}};window.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};window.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};window.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};window.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-840,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};window.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var r=BX.util.trim(t[n]);if(r.length>0){var a=this.hiddenField.value.split(",");if(!BX.util.in_array(r,a)){var o;var s=BX.create("span",{children:[o=BX.create("span",{attrs:{class:"feed-add-post-del-but"}})],attrs:{class:"feed-add-post-tags"}});s.insertBefore(document.createTextNode(r),o);this.tagsContainer.insertBefore(s,this.addNewLink);BX.bind(o,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:s,tagValue:r}));this.hiddenField.value+=r+",";i.push(r)}}}return i};window.BXPostFormTags.prototype.onTagAdd=function(){this.addTag();this.popupInput.value="";this.popup.close()};window.BXPostFormTags.prototype.onAddNewClick=function(e){e=e||window.event;this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onButtonClick=function(e){e=e||window.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onKeyPress=function(e){e=e||window.event;var t=e.keyCode?e.keyCode:e.which?e.which:null;if(t==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};window.BXPostFormImportant=function(e,t,i){if(i){this.formID=e;this.buttonID=t;this.inputName=i;this.fireButton=null;this.activeBlock=null;this.hiddenField=null;BX.ready(BX.proxy(this.init,this))}return false};window.BXPostFormImportant.prototype.init=function(){this.fireButton=BX(this.buttonID);this.activeBlock=BX(this.buttonID+"-active");var e=BX(this.formID);if(e){this.hiddenField=e[this.inputName];if(this.hiddenField&&this.hiddenField.value==1){this.showActive()}}BX.bind(this.fireButton,"click",BX.proxy((function(e){e=e||window.event;this.showActive();BX.PreventDefault(e)}),this));BX.bind(this.activeBlock,"click",BX.proxy((function(e){e=e||window.event;this.hideActive();BX.PreventDefault(e)}),this))};window.BXPostFormImportant.prototype.showActive=function(e){BX.hide(this.fireButton);BX.show(this.activeBlock,"inline-block");if(this.hiddenField){this.hiddenField.value=1}return false};window.BXPostFormImportant.prototype.hideActive=function(e){BX.hide(this.activeBlock);BX.show(this.fireButton,"inline-block");if(this.hiddenField){this.hiddenField.value=0}return false};var t=null;window.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e)){e=null}e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"ui-btn-clock");t=e;BX.defer((function(){e.disabled=true}))()}};var i={listen:false,plus:false,text:"",bSearch:false,node:null,mode:null};BX.addCustomEvent(window,"onInitialized",(function(e){if(e&&e.eventNode){BX.onCustomEvent(e.eventNode,"OnClickCancel",(function(){i.node=null}))}}));BX.addCustomEvent(window,"BX.MPF.MentionSelector:open",(function(t){var i=BX.Type.isStringFilled(t.formId)?t.formId:"";if(!BX.Type.isStringFilled(i)||BX.Type.isUndefined(e.mentionParams[i])){return}var n=BX.Type.isDomNode(t.bindNode)?t.bindNode:null;var r=BX.type.isNotEmptyObject(t.bindPosition)?t.bindPosition:null;var a=window.MPFgetSelectorId("bx-mention-"+i+"-id")+(n?"-withsearch":"");var o=BX.UI.EntitySelector.Dialog.getById(a);if(!o){window.MPFcreateSelectorDialog({formId:i,selectorId:a,enableSearch:!!n,params:e.mentionParams[i]});o=BX.UI.EntitySelector.Dialog.getById(a)}if(!o){return}o.deselectAll();o.search("");o.show();var s={};if(BX.Type.isDomNode(n)){o.focusSearch();o.popup.setBindElement(n);s.position="top"}else if(BX.type.isNotEmptyObject(r)){r.top-=5;o.popup.setBindElement(r)}o.popup.adjustPosition(s)}));window.onKeyDownHandler=function(e,t,r){var a=e.keyCode;if(!window["BXfpdStopMent"+r]){return true}var o=window.MPFgetSelectorId("bx-mention-"+r+"-id");if(a===t.KEY_CODES["backspace"]&&i.node){var s=BX.util.trim(t.util.GetTextContent(i.node));if(s==="+"||s==="@"||i.mode=="button"&&s.length==1){window["BXfpdStopMent"+r]()}else if(i.mode=="button"&&s.length==1){window["BXfpdStopMent"+r]()}}if(BX.util.in_array(a,[107,187])||(e.shiftKey||e.modifiers>3)&&BX.util.in_array(a,[50,43,61])||e.altKey&&BX.util.in_array(a,[76])||e.altKey&&e.ctrlKey&&BX.util.in_array(a,[81])&&e.key==="@"||e.altKey&&BX.util.in_array(a,[71,81])&&e.key==="@"||e.altKey&&BX.util.in_array(a,[50])&&e.key==="@"||BX.Type.isFunction(e.getModifierState)&&!!e.getModifierState("AltGraph")&&BX.util.in_array(a,[81,50,48])&&!BX.Type.isUndefined(e.key)&&e.key==="@"||BX.util.in_array(a,[192])&&e.key==="@"){setTimeout((function(){var e=t.selection.GetRange();var a=t.GetIframeDoc();var s=e?e.endContainer.textContent:"";var l=s?s.slice(e.endOffset-1,e.endOffset):"";var d=s?s.slice(e.endOffset-2,e.endOffset-1):"";if((l=="@"||l=="+")&&(!d||BX.util.in_array(d,["+","@",",","("])||d.length==1&&BX.util.trim(d)==="")){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=true;i.mode="plus";e.setStart(e.endContainer,e.endOffset-1);e.setEnd(e.endContainer,e.endOffset);t.selection.SetSelection(e);i.node=BX.create("SPAN",{props:{id:"bx-mention-node"}},a);t.selection.Surround(i.node,e);e.setStart(i.node,1);e.setEnd(i.node,1);t.selection.SetSelection(e);if(BX.Type.isStringFilled(o)){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:r,bindPosition:n(i.node,t)}])}}}),10)}if(i.listen){var l=null;var d=BX.Type.isStringFilled(o)?BX.UI.EntitySelector.Dialog.getById(o):null;if(d&&d.getActiveTab()){l=d.getActiveTab().getId()}var c=null;switch(a){case t.KEY_CODES.enter:c="Enter";break;case 9:c="Tab";break;case t.KEY_CODES.up:c="ArrowUp";break;case t.KEY_CODES.down:c="ArrowDown";break;case t.KEY_CODES.left:if(l==="departments"){c="ArrowLeft"}break;case t.KEY_CODES.right:if(l==="departments"){c="ArrowRight"}break}if(c){var u=new KeyboardEvent("keydown",{key:c,keyCode:a,bubbles:true,cancelable:true,view:window});if(!document.dispatchEvent(u)){t.iframeKeyDownPreventDefault=true;e.stopPropagation();e.preventDefault()}}}if(!i.listen&&i.listenFlag&&a===t.KEY_CODES["enter"]){var f=t.selection.GetRange();if(f.collapsed){var p=f.endContainer;var h=t.GetIframeDoc();if(p){if(p.className!=="bxhtmled-metion"){p=BX.findParent(p,(function(e){return e.className=="bxhtmled-metion"}),h.body)}if(p&&p.className=="bxhtmled-metion"){t.selection.SetAfter(p)}}}}};window.onKeyUpHandler=function(e,t,n){var r=e.keyCode;var a;var o;if(!window["BXfpdStopMent"+n]){return true}if(i.listen===true){if(r==t.KEY_CODES.escape){var s=new KeyboardEvent("keyup",{key:"Escape",keyCode:r,bubbles:true,cancelable:true,view:window});if(!document.dispatchEvent(s)){e.stopPropagation();e.preventDefault()}window["BXfpdStopMent"+n]()}else if(r!==t.KEY_CODES.enter&&r!==t.KEY_CODES.left&&r!==t.KEY_CODES.right&&r!==t.KEY_CODES.up&&r!==t.KEY_CODES.down){if(BX(i.node)){o=BX.util.trim(t.util.GetTextContent(i.node));var l=o;o=o.replace(/^[\+@]*/,"");i.bSearch=BX.Type.isStringFilled(o);var d=window.MPFgetSelectorId("bx-mention-"+n+"-id");var c=BX.UI.EntitySelector.Dialog.getById(d);if(BX.Type.isStringFilled(o)&&c){c.search(o)}if(i.leaveContent&&i._lastText){if(l===""){window["BXfpdStopMent"+n]()}else if(l!==""&&o===""){i.bSearch=false;if(c){c.search("")}}}i.lastText=o;i._lastText=l}else{window["BXfpdStopMent"+n]()}}}else{if(!e.shiftKey&&(r===t.KEY_CODES["space"]||r===t.KEY_CODES["escape"]||r===188||r===190)){a=t.selection.GetRange();if(a.collapsed){var u=a.endContainer;var f=t.GetIframeDoc();if(u){if(u.className!=="bxhtmled-metion"){u=BX.findParent(u,(function(e){return e.className=="bxhtmled-metion"}),f.body)}if(u&&u.className=="bxhtmled-metion"){o=t.util.GetTextContent(u);var p=o.match(/[\s\.\,]$/);if(p||r===t.KEY_CODES["escape"]){u.innerHTML=o.replace(/[\s\.\,]$/,"");var h=BX.create("SPAN",{html:p||t.INVISIBLE_SPACE},f);t.util.InsertAfter(h,u);t.selection.SetAfter(h)}}}}}}};window.onTextareaKeyDownHandler=function(e,t,n){var r=e.keyCode;if(i.listen&&r==t.KEY_CODES.enter){t.textareaKeyDownPreventDefault=true;e.stopPropagation();e.preventDefault()}};window.onTextareaKeyUpHandler=function(e,t,n){var r=null;var a="";var o=e.keyCode;var s=window.MPFgetSelectorId("bx-mention-"+n+"-id");if(i.listen===true){if(o==27){window["BXfpdStopMent"+n]()}else if(o!==13){a=t.textareaView.GetValue(false);r=t.textareaView.GetCursorPosition();var l="";var d="";if(a.indexOf("+")!==-1||a.indexOf("@")!==-1){var c=a.substr(0,r);var u=Math.max(c.lastIndexOf("+"),c.lastIndexOf("@"));if(u>=0){l=c.substr(u);d=l;l=l.replace(/^[\+@]*/,"");i.bSearch=BX.Type.isStringFilled(l);var f=BX.UI.EntitySelector.Dialog.getById(s);if(BX.Type.isStringFilled(l)&&f){f.search(l)}}}if(i._lastText){if(d===""){window["BXfpdStopMent"+n]()}else if(d!==""&&l===""){i.bSearch=false;if(f){f.search("")}}}i.lastText=l;i._lastText=d}}else{if(o==16){var p=this;this.shiftPressed=true;if(this.shiftTimeout){this.shiftTimeout=clearTimeout(this.shiftTimeout)}this.shiftTimeout=setTimeout((function(){p.shiftPressed=false}),100)}if(o==107||(e.shiftKey||e.modifiers>3||this.shiftPressed)&&BX.util.in_array(o,[187,50,107,43,61])){r=t.textareaView.element.selectionStart;if(r>0){a=t.textareaView.element.value;var h=a.substr(r-1,1);if(h&&(h==="+"||h==="@")){i.listen=true;i.listenFlag=true;i.text="";i.textarea=true;i.bSearch=false;i.mode="plus";BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:n,bindPosition:BX.pos(document.getElementById("bx-b-mention-"+n))}])}}}}};var n=function(e,t){var i=BX.pos(e);var n=BX.pos(t.dom.areaCont);var r=BX.GetWindowScrollPos(t.GetIframeDoc());var a=n.top+i.bottom-r.scrollTop+2;var o=n.left+i.right-r.scrollLeft;return{top:a,left:o}};window.BxInsertMention=function(e){var t=e.item;var r=e.type;var a=e.formID;var o=e.editorId;var s=e.bNeedComa;var l=LHEPostForm.getEditor(o);var d;if((r==="user"||r==="project"||r==="department")&&t&&t.entityId>0&&l){if(l.GetViewMode()=="wysiwyg"){var c=l.GetIframeDoc();var u=l.selection.GetRange();var f=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},c);d=BX.create("SPAN",{html:s?",&nbsp;":"&nbsp;"},c);var p={tag:"postuser",params:{value:t.entityId}};switch(r){case"project":p.projectId=t.entityId;p.projectName=t.name;break;case"department":p.departmentId=t.entityId;p.departmentName=t.name;break;default:p.userId=t.entityId;p.userName=t.name}l.SetBxTag(f,p);if(BX(i.node)&&i.node.parentNode){l.util.ReplaceNode(i.node,f)}else{l.selection.InsertNode(f,u)}if(f&&f.parentNode){var h=BX.findParent(f,{className:"bxhtmled-metion"},c.body);if(h){l.util.InsertAfter(f,h)}}if(f&&f.parentNode){l.util.InsertAfter(d,f);l.selection.SetAfter(d)}}else if(l.GetViewMode()=="code"&&l.bbCode){l.textareaView.Focus();var b=l.textareaView.GetValue(false);var m=l.textareaView.GetCursorPosition();var v=b.substr(0,m);var E=Math.max(v.lastIndexOf("+"),v.lastIndexOf("@"));if(E>=0&&m>E){l.textareaView.SetValue(b.substr(0,E)+b.substr(m));l.textareaView.element.setSelectionRange(E,E)}var g="";switch(r){case"user":g="USER";break;case"project":g="PROJECT";break;case"department":g="DEPARTMENT";break;default:}l.textareaView.WrapWith(false,false,"["+g+"="+t.entityId+"]"+t.name+"[/"+g+"]"+(s?", ":" "))}if(e.fireAddEvent===true){BX.onCustomEvent(window,"onMentionAdd",[t,r])}if(window["BXfpdStopMent"+a]){window["BXfpdStopMent"+a]()}i["text"]="";if(l.GetViewMode()=="wysiwyg"){l.Focus();l.selection.SetAfter(d)}var y=LHEPostForm.getHandler(o);if(y&&y.formEntityType==="task"&&y.editorParams.tasksLimitExceeded){BX.Main.PostFormTasksLimit.showPopup({bindPosition:n(i.node,l)})}}};window.MPFgetSelectorId=function(e){var t=false;var i=BX(e);if(!i){return t}t=i.getAttribute("data-bx-selector-id");return t};window.MPFcreateSelectorDialog=function(e){new BX.UI.EntitySelector.Dialog({targetNode:"mpf-mention-"+e.formId,id:e.selectorId,context:"MENTION",multiple:false,enableSearch:e.enableSearch,clearSearchOnSelect:true,hideOnSelect:true,hideByEsc:true,entities:e.params.entities,height:300,width:400,compactView:true,events:{onShow:function(){window.BXfpdOnDialogOpen()},onHide:function(){window.BXfpdOnDialogClose({editorId:e.params.editorId})},"Item:onSelect":function(t){var i=t.getData().item;if(i){window["BXfpdSelectCallbackMent"+e.formId]({item:{name:i.getTitle(),entityId:i.getId()},entityType:i.getEntityId()})}}}})};window.MPFMentionInit=function(t,n){e.mentionParams[t]=n;if(n.initDestination===true){BX.addCustomEvent("onAutoSaveRestoreDestination",(function(e){if(BX.type.isNotEmptyObject(e)&&BX.type.isNotEmptyObject(e.data)&&BX.type.isNotEmptyString(e.data.DEST_DATA)&&BX.type.isNotEmptyString(e.formId)&&e.formId==t&&BX.UI.EntitySelector){var i=JSON.parse(e.data.DEST_DATA);if(!Array.isArray(i)){return}var n=BX.UI.EntitySelector.Dialog.getById("oPostFormLHE_blogPostForm");if(!BX.type.isNotEmptyObject(n)){return}n.preselectedItems=i;n.setPreselectedItems(i)}}));BX.addCustomEvent(window,"onMentionAdd",(function(e,t){var i=BX.UI.EntitySelector.Dialog.getById("oPostFormLHE_blogPostForm");if(!BX.type.isNotEmptyObject(i)){return}var n="";if(t==="user"){if(e.isExtranet==="Y"){n="extranet"}else if(e.isEmail==="Y"){n="email"}else{n="employee"}}else if(t==="project"){if(e.isExtranet==="Y"){n="extranet"}}i.addItem({avatar:e.avatar,customData:{email:BX.Type.isStringFilled(e.email)?e.email:""},entityId:t,entityType:n,id:e.entityId,title:e.name}).select()}))}window["BXfpdSelectCallbackMent"+t]=function(e){window.BxInsertMention({item:e.item,type:e.entityType.toLowerCase(),formID:t,editorId:n.editorId,fireAddEvent:n.initDestination})};window["BXfpdStopMent"+t]=function(){var e=window.MPFgetSelectorId("bx-mention-"+t+"-id");var i=BX.UI.EntitySelector.Dialog.getById(e);if(i){i.hide()}};if(BX(t)){BX.addCustomEvent(BX(t),"OnUCFormAfterShow",(function(e){if(!BX.type.isNotEmptyObject(e)||!BX.type.isArray(e.id)||!BX.Type.isStringFilled(e.id[0])){return}var t=new RegExp("EVENT_(\\d+)","i");if(!t.test(e.id[0])){return}}))}var r=LHEPostForm.getHandlerByFormId(t);if(r){r.exec()}BX.ready((function(){var e=BX("bx-b-mention-"+t);BX.bind(e,"click",(function(r){if(i.listen!==true){var a=LHEPostForm.getEditor(n.editorId);var o=a.GetIframeDoc();if(a.GetViewMode()=="wysiwyg"&&o){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=false;i.mode="button";var s=a.selection.GetRange();if(BX(i.node)){BX.remove(BX(i.node))}a.InsertHtml('<span id="bx-mention-node">'+a.INVISIBLE_SPACE+"</span>",s);setTimeout((function(){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:t,bindNode:e}]);i.node=o.getElementById("bx-mention-node");if(i.node){s.setStart(i.node,0);if(i.node.firstChild&&i.node.firstChild.nodeType==3&&i.node.firstChild.nodeValue.length>0){s.setEnd(i.node,1)}else{s.setEnd(i.node,0)}a.selection.SetSelection(s)}a.Focus()}),100)}else if(a.GetViewMode()=="code"){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=false;i.mode="button";setTimeout((function(){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{formId:t,bindNode:e}])}),100)}BX.onCustomEvent(e,"mentionClick")}}))}))};window.BXfpdOnDialogOpen=function(){i.listen=true;i.listenFlag=true};window.BXfpdOnDialogClose=function(e){i.listen=false;setTimeout((function(){i.listenFlag=false;if(!i.listen){var t=LHEPostForm.getEditor(e.editorId);if(t){t.Focus()}}}),100)};MPFEntitySelector=function(t){this.selector=null;this.inputNode=null;this.messages={};if(!BX.Type.isStringFilled(t.id)){return null}if(e.selector[t.id]){return e.selector[t.id]}e.selector[t.id]=this.init(t)};MPFEntitySelector.prototype.init=function(e){if(!BX.type.isPlainObject(e)){e={}}if(!BX.Type.isStringFilled(e.id)||!BX.Type.isStringFilled(e.tagNodeId)||!BX(e.tagNodeId)){return null}if(BX.Type.isStringFilled(e.inputNodeId)&&BX(e.inputNodeId)){this.inputNode=BX(e.inputNodeId)}if(BX.type.isNotEmptyObject(e.messages)){this.messages=e.messages}this.selector=new BX.UI.EntitySelector.TagSelector({id:e.id,dialogOptions:{id:e.id,context:BX.Type.isStringFilled(e.context)?e.context:null,preselectedItems:BX.type.isArray(e.preselectedItems)?e.preselectedItems:[],events:{"Item:onSelect":function(){this.recalcValue(this.selector.getDialog().getSelectedItems())}.bind(this),"Item:onDeselect":function(){this.recalcValue(this.selector.getDialog().getSelectedItems())}.bind(this)},entities:[{id:"meta-user",options:{"all-users":{title:this.messages.allUsersTitle,allowView:BX.type.isBoolean(e.allowToAll)&&e.allowToAll}}},{id:"user",options:{emailUsers:BX.type.isBoolean(e.allowSearchEmailUsers)?e.allowSearchEmailUsers:false,inviteGuestLink:BX.type.isBoolean(e.allowSearchEmailUsers)?e.allowSearchEmailUsers:false,myEmailUsers:true}},{id:"project",options:{features:{blog:["premoderate_post","moderate_post","write_post","full_post"]}}},{id:"department",options:{selectMode:"usersAndDepartments",allowFlatDepartments:false}}]},addButtonCaption:BX.message("BX_FPD_LINK_1"),addButtonCaptionMore:BX.message("BX_FPD_LINK_2")});this.selector.renderTo(document.getElementById(e.tagNodeId));return this.selector};MPFEntitySelector.prototype.recalcValue=function(e){if(!BX.type.isArray(e)||!this.inputNode){return}var t=[];e.forEach((function(e){t.push([e.entityId,e.id])}));this.inputNode.value=JSON.stringify(t)};window.MPFEntitySelector=MPFEntitySelector})()})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:71:"/bitrix/components/bitrix/system.field.edit/script.min.js?1688331294814";s:6:"source";s:53:"/bitrix/components/bitrix/system.field.edit/script.js";s:3:"min";s:57:"/bitrix/components/bitrix/system.field.edit/script.min.js";s:3:"map";s:57:"/bitrix/components/bitrix/system.field.edit/script.map.js";}"*/
function addElement(e,n){if(document.getElementById("main_"+e)){var d=document.getElementById("main_"+e).getElementsByTagName("div");if(d&&d.length>0&&d[0]){var t=d[0].parentNode;t.appendChild(d[d.length-1].cloneNode(true))}}}function addElementFile(e,n){var d=document.getElementById("main_"+e);var t=document.getElementById("main_add_"+e);if(d&&t){t=t.cloneNode(true);t.id="";t.style.display="";d.appendChild(t)}}function addElementDate(e,n){var d=document.getElementById("date_container_"+n);var t=document.getElementById("hidden_"+n).innerHTML;if(d&&t){var a=e[n].fieldName;var i=e[n].index;t=t.replace(/[#]FIELD_NAME[#]/g,a+"["+i+"]");t=t.replace(/[\%]23FIELD_NAME[\%]23/g,escape(a+"["+i+"]"));var l=d.appendChild(document.createElement("DIV"));l.innerHTML+=t;e[n].index++}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?168833132866406";s:6:"source";s:67:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.js";s:3:"min";s:71:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js";s:3:"map";s:71:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.map.js";}"*/
this.BX=this.BX||{};this.BX.Disk=this.BX.Disk||{};(function(e,t,i,n,a,r,s){"use strict";var o=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"set",value:function t(i){for(var n in i){if(e.hasOwnProperty(n)){e[n]=i[n]}}}},{key:"getDocumentHandlers",value:function t(){if(!e.documentHandlers){return[]}return e.documentHandlers}},{key:"getDocumentHandler",value:function t(i){if(!e.documentHandlers){return{}}var n=e.documentHandlers.find((function(e){return e.code===i}));return n||{}}}]);return e}();babelHelpers.defineProperty(o,"urlUpload",null);babelHelpers.defineProperty(o,"documentHandlers",null);babelHelpers.defineProperty(o,"previewSize",{width:115,height:115});var l;var c=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.id=t;this.object=i;this.data={NAME:i.name};s.EventEmitter.subscribe(this.object,"onUploadProgress",this.onUploadProgress.bind(this));s.EventEmitter.subscribe(this.object,"onUploadDone",this.onUploadDone.bind(this));s.EventEmitter.subscribe(this.object,"onUploadError",this.onUploadError.bind(this));this.progress=new BX.UI.ProgressRound({width:18,colorTrack:"rgba(255,255,255,.3)",colorBar:"#fff",lineSize:3,statusType:BX.UI.ProgressRound.Status.INCIRCLE,textBefore:"<i></i>",textAfter:this.object.size})}babelHelpers.createClass(e,[{key:"getContainer",value:function e(){if(!this.container){var t=this.object.name.split(".").pop().toLowerCase();t=r.Text.encode(t===this.object.name?"":t);this.container=r.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-file disk-file-thumb--',' disk-file-thumb--active">\n\t\t\t<div class="ui-icon ui-icon-file-',' disk-file-thumb-icon"><i></i></div>\n\t\t\t<div class="disk-file-thumb-text">','</div>\n\t\t\t<div class="disk-file-thumb-loader">\n\t\t\t\t','\n\t\t\t\t<div class="disk-file-thumb-loader-btn" onclick="','"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t'])),t,t,r.Text.encode(this.object.name),this.progress.getContainer(),this.onClickDelete.bind(this))}return this.container}},{key:"onClickDelete",value:function e(t){var i=this;t.preventDefault();t.stopPropagation();s.EventEmitter.emit(this,"onDelete",[this]);setTimeout((function(){i.object.deleteFile()}),400);delete this.container}},{key:"onUploadProgress",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,2),n=i[0],a=i[1];a=Math.min(Math.max(this.progress.getValue(),a),98);this.progress.update(a)}},{key:"onUploadDone",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,2),n=i[0],a=i[1].file;s.EventEmitter.emit(this,"onUploadDone",[a,n.file]);delete this.object.hash;this.object.deleteFile()}},{key:"onUploadError",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,1),n=i[0];s.EventEmitter.emit(this,"onUploadError",[n.file]);this.progress.setTextBefore(r.Loc.getMessage("WDUF_ITEM_ERROR"));this.container.classList.add("disk-file-upload-error");this.object.deleteFile()}}]);return e}();function u(e,t,i){d(e,t);t.set(e,i)}function d(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(e,t,i){b(e,t);p(i,"get");return f(e,i)}function p(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function b(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function f(e,t){if(t.get){return t.get.call(e)}return t.value}var m=new WeakMap;var v=function(){function e(t){var i=t.id,n=t.container,a=t.dropZone,r=t.input;babelHelpers.classCallCheck(this,e);u(this,m,{writable:true,value:0});this.container=n;this.agent=BX.Uploader.getInstance({id:i,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:o.urlUpload,showImage:false,sortItems:false,dropZone:a,input:r,pasteFileHashInForm:false});s.EventEmitter.subscribe(this.agent,"onFileIsCreated",this.catchFile.bind(this));s.EventEmitter.subscribe(this.agent,"onPackageIsInitialized",(function(e){var t=babelHelpers.slicedToArray(e.compatData,1),i=t[0];var n={width:o.previewSize.width,height:o.previewSize.height,exact:"N"};if(i.data){i.data["previewParams"]=n}else{i.post.data["previewParams"]=n}}))}babelHelpers.createClass(e,[{key:"catchFile",value:function t(i){var n=this;var a=babelHelpers.slicedToArray(i.compatData,2),r=a[0],o=a[1];this.incrementItemsCount();var l=new c(r,o);s.EventEmitter.subscribe(l,"onUploadDone",(function(t){var i=babelHelpers.slicedToArray(t.data,2),a=i[0],r=i[1];if(!l[h(n.constructor,e,g)]){n.decrementItemsCount();s.EventEmitter.emit(n,"onUploadDone",{itemData:n.convertToItemSavedType(a),itemContainer:l.getContainer(),blob:r})}}));s.EventEmitter.subscribe(l,"onUploadError",(function(t){var i=babelHelpers.slicedToArray(t.data,1),a=i[0];n.decrementItemsCount();l[h(n.constructor,e,g)]=true;s.EventEmitter.emit(n,"onUploadError",{itemContainer:l.getContainer(),blob:a})}));s.EventEmitter.subscribe(l,"onDelete",(function(){n.decrementItemsCount();l[h(n.constructor,e,g)]=true;n.container.removeChild(l.getContainer())}));this.container.appendChild(l.getContainer())}},{key:"addTestThumb",value:function e(t){var i=this;var n=new c(Math.ceil(Math.random()*1e3),{name:"test.file.js",size:"348 Kb",deleteFile:function e(){}});this.container.appendChild(n.getContainer());if(t>0){n.onUploadProgress({compatData:[null,t]})}s.EventEmitter.subscribe(n,"onDelete",(function(){i.container.removeChild(n.getContainer())}))}},{key:"addTestErrorThumb",value:function e(){var t=this;var i=new c(Math.ceil(Math.random()*1e3),{name:"test.file.js",size:"348 Kb",deleteFile:function e(){}});this.container.appendChild(i.getContainer());i.onUploadError({compatData:[{file:null}]});s.EventEmitter.subscribe(i,"onDelete",(function(){t.container.removeChild(i.getContainer())}))}},{key:"upload",value:function e(t){var i=babelHelpers.toArray(t),n=i.slice(0);this.agent.onAttach(n)}},{key:"convertToItemSavedType",value:function e(t){return{ID:t.attachId,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:false,CAN_RESTORE:false,CAN_UPDATE:t.canChangeName,CAN_RENAME:t.canChangeName,CAN_MOVE:t.canChangeName,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:t.previewUrl?t.previewUrl:"",BIG_PREVIEW_URL:t.previewUrl?t.previewUrl.replace(/\&(width|height)=\d+/gi,""):null,EXTENSION:t.ext,NAME:t.name,SIZE:t.size,SIZE_BYTES:t.sizeInt,STORAGE:t.storage,TYPE_FILE:t.fileType}}},{key:"incrementItemsCount",value:function e(){var t;if(babelHelpers.classPrivateFieldGet(this,m)<=0){s.EventEmitter.emit(this,"onUploadIsStart")}babelHelpers.classPrivateFieldSet(this,m,(t=+babelHelpers.classPrivateFieldGet(this,m))+1),t}},{key:"decrementItemsCount",value:function e(){var t;if(babelHelpers.classPrivateFieldGet(this,m)===1){s.EventEmitter.emit(this,"onUploadIsDone")}babelHelpers.classPrivateFieldSet(this,m,Math.max((babelHelpers.classPrivateFieldSet(this,m,(t=+babelHelpers.classPrivateFieldGet(this,m))-1),t),0))}}]);return e}();var g={writable:true,value:Symbol("deleted")};var E=function(){function e(t){var i=t.container,n=t.eventObject;babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"hasContainer",false);babelHelpers.defineProperty(this,"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(this,"properties",{pluggedIn:false});this.container=i;this.eventObject=n;this.properties.pluggedIn=this.eventObject&&this.eventObject.dataset.bxHtmlEditable==="Y";if(!this.container){return}this.hasContainer=true}babelHelpers.createClass(e,[{key:"isRelevant",value:function e(){return this.hasContainer}},{key:"getEventObject",value:function e(){return this.eventObject}},{key:"getContainer",value:function e(){return this.container}},{key:"isPluggedIn",value:function e(){return this.properties.pluggedIn}},{key:"show",value:function e(){this.container.style.display="";delete this.container.style.display}},{key:"hide",value:function e(){this.container.style.display="none"}}]);return e}();var D;var I=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"hiddenFilesCount",0);babelHelpers.defineProperty(this,"stepNumber",0);babelHelpers.defineProperty(this,"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(this,"stepValue",5)}babelHelpers.createClass(e,[{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return r.Tag.render(D||(D=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-file" onclick="','">\n\t\t\t<div class="ui-icon ui-icon-more disk-file-thumb-icon">\n\t\t\t\t<i></i>\n\t\t\t</div>\n\t\t\t<div class="disk-file-thumb-text">',"</div>\n\t\t</div>"])),t.onClick.bind(t),t.getValueContainer())}))}},{key:"getValueContainer",value:function e(){return this.cache.remember("valueContainer",(function(){return document.createElement("DIV")}))}},{key:"reset",value:function e(){this.hiddenFilesCount=1;this.stepNumber=0;this.getValueContainer().innerHTML=this.hiddenFilesCount;this.show();return this}},{key:"increment",value:function e(){this.hiddenFilesCount++;this.getValueContainer().innerHTML=this.hiddenFilesCount;this.show()}},{key:"decrement",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;this.hiddenFilesCount-=t;this.getValueContainer().innerHTML=this.hiddenFilesCount;if(this.hiddenFilesCount<=0){this.hide()}}},{key:"onClick",value:function e(){this.stepNumber++;var t=Math.min(30,this.stepValue*this.stepNumber);this.decrement(t);s.EventEmitter.emit(this,"onGetMore",{itemsCount:t})}},{key:"show",value:function e(){delete this.getContainer().style.display}},{key:"hide",value:function e(){this.getContainer().style.display="none"}}]);return e}();var k=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"getSelectedFile",value:function e(t,i,n){var a=this;return new Promise((function(e){r.ajax.get(r.Uri.addParam(a.urlSelect,{ACTION:"none",MULTI:"Y",ID:["E",t].join(""),NAME:i,wish:"fakemove",dialogName:n}),e)}))}},{key:"loadFolder",value:function e(t,i,n){var a=t;var s=r.Uri.addParam([BX.DiskFileDialog.obCurrentTab[n].link.replace("/index.php","").replace("/files/lib/","/files/"),"element/upload",a].join("/"),{use_light_view:"Y",AJAX_CALL:"Y",SIMPLE_UPLOAD:"Y",IFRAME:"Y",sessid:BX.bitrix_sessid(),SECTION_ID:a,CHECK_NAME:i});return new Promise((function(e){r.ajax.loadJSON(s,{},e)}))}},{key:"getSelectedData",value:function e(t){var i=this;return new Promise((function(e){r.ajax.get(r.Uri.addParam(i.urlSelect,{dialogName:t}),e)}))}},{key:"getSelectedCloudData",value:function e(t,i){var n=this;return new Promise((function(e){r.ajax.get(r.Uri.addParam(n.urlSelect,{cloudImport:1,service:i,dialogName:t}),e)}))}},{key:"moveFile",value:function e(t,i){return new Promise((function(e){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","moveUploadedFile"),data:{attachedId:t,targetFolderId:i},onsuccess:e})}))}},{key:"getMetaDataForCreatedFileInUf",value:function e(t){return r.ajax.runAction("disk.api.file.getMetaDataForCreatedFileInUf",{data:{id:t}})}},{key:"renameAction",value:function e(t,i){return new Promise((function(e){r.ajax.post("/bitrix/tools/disk/uf.php?action=renameFile",{newName:i,attachedId:t,sessid:r.Loc.getMessage("bitrix_sessid")},e)}))}},{key:"deleteAction",value:function e(t){return new Promise((function(e){r.ajax.post("/bitrix/tools/disk/uf.php?action=deleteFile",{attachedId:t,sessid:r.Loc.getMessage("bitrix_sessid")},e)}))}}]);return e}();babelHelpers.defineProperty(k,"urlSelect","/bitrix/tools/disk/uf.php?action=selectFile&SITE_ID="+r.Loc.getMessage("SITE_ID")+"&dialog2=Y&ACTION=SELECT&MULTI=Y");var C,y,T,S,_,w,F;function A(e,t){U(e,t);t.add(e)}function L(e,t,i){U(e,t);t.set(e,i)}function U(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function N(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var H=new WeakMap;var x=new WeakSet;var O=new WeakSet;var P=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));A(babelHelpers.assertThisInitialized(i),O);A(babelHelpers.assertThisInitialized(i),x);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"properties",{pluggedIn:false,insertedInText:false});L(babelHelpers.assertThisInitialized(i),H,{writable:true,value:void 0});i.setEventNamespace("Disk:UF:");i.id=String(e["ID"]);i.setData(e);i.subscribe("onMoved",i.onMoved.bind(babelHelpers.assertThisInitialized(i)));return i}babelHelpers.createClass(t,[{key:"getId",value:function e(){return this.id}},{key:"getFileId",value:function e(){return this.data.FILE_ID}},{key:"getData",value:function e(t){if(t){return this.data[t]}return this.data}},{key:"getAllIds",value:function e(){return[this.getId(),["n",this.data.FILE_ID].join("")]}},{key:"setData",value:function e(t){this.data=t}},{key:"setPluggedIn",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.properties.pluggedIn=t===true}},{key:"isPluggedIn",value:function e(){return this.properties.pluggedIn}},{key:"setInsertedInText",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.properties.insertedInText=t===true;r.Dom.addClass(this.getContainer(),"--edit-text-preview")}},{key:"isInsertedInText",value:function e(){return this.properties.insertedInText}},{key:"getNameWithoutExtension",value:function e(){var t=this.data["NAME"].split(".");if(t.length>1){t.pop()}var i=t.join(".");if(i.length>50){return i.substr(0,39)+"..."+i.substr(-5)}return i}},{key:"getButtonBox",value:function e(){var t="";if(this.isPluggedIn()){t=r.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="disk-file-thumb-btn-text-copy"\n\t\t\t\t\tonclick="','"\n\t\t\t\t\tonmouseenter="','"\n\t\t\t\t\tonmouseleave="','"\n\t\t\t\t>\n\t\t\t\t</div>'])),this.onClickInsertInText.bind(this),N(this,x,M).bind(this),N(this,O,R).bind(this))}return r.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-file-thumb-btn-box">\n\t\t\t\t','\n\t\t\t\t<div class="disk-file-thumb-btn-more" data-bx-role="more" onclick="','"></div>\n\t\t\t</div>\n\t\t'])),t,this.onClickMore.bind(this))}},{key:"getDeleteButton",value:function e(){return r.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-file-thumb-btn-close-box">\n\t\t\t\t<div class="disk-file-thumb-btn-close" onclick="','"></div>\n\t\t\t</div>\n\t\t'])),this.onClickDelete.bind(this))}},{key:"getNameBox",value:function e(t,i){var n="";if(i){n=r.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<span class="disk-file-thumb-file-extension">.',"</span>"])),i)}return r.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="disk-file-thumb-text-box">\n\t\t\t\t<div data-bx-role="name" class="disk-file-thumb-text">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),t,n)}},{key:"getIcon",value:function e(t){return r.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div data-bx-role="icon" class="ui-icon ui-icon-file-',' disk-file-thumb-icon"><i></i></div>\n\t\t'])),t)}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){var e=r.Text.encode(t.getNameWithoutExtension());var i=r.Text.encode(t.data["EXTENSION"]).toLowerCase();switch(i){case"pptx":i="ppt";break}return r.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-file disk-file-thumb--','">\n\t\t\t',"\n\t\t\t","\n\t\t\t","\n\t\t\t","\n\t\t</div>"])),i,t.getIcon(i),t.getNameBox(e,i),t.getDeleteButton(),t.getButtonBox())}))}},{key:"rename",value:function e(t){this.data["NAME"]=t;if(this.hasContainer()){this.getContainer().querySelector('[data-bx-role="name"]').innerHTML=r.Text.encode(this.data["NAME"])}}},{key:"destroy",value:function e(){var t=this;var i=this.cache.keys();i.forEach((function(e){var i=t.cache.get(e);if(r.Type.isDomNode(i)&&i.parentNode){i.parentNode.removeChild(i)}t.cache["delete"](e)}));this.emit("onDestroy")}},{key:"hasContainer",value:function e(){return this.cache.has("container")}},{key:"getMenu",value:function e(){var t=this;var n=this.getData("NAME").split(".").pop();n=n===this.getData("NAME")?"":[".",n].join("");var a=String(this.getData("NAME"));var s=a.substring(0,a.length-n.length);return this.cache.remember("menu",(function(){var e=t.getContainer().querySelector("div[data-bx-role='more']");var a=new i.Menu({id:"crm-tunnels-menu-".concat(r.Text.getRandom().toLowerCase()),bindElement:e,items:[t.isPluggedIn()?{dataset:{bxRole:"insertIntoTheText"},text:r.Loc.getMessage("WDUF_ITEM_MENU_INSERT_INTO_THE_TEXT"),onclick:function e(i,n){a.close();t.onClickInsertInText(i)}}:null,{dataset:{bxRole:"deleteFile"},text:r.Loc.getMessage("WDUF_ITEM_MENU_DELETE"),onclick:function e(i){a.close();t.onClickDelete(i)}},t.data["CAN_RENAME"]===true?{dataset:{bxRole:"renameFile"},text:r.Loc.getMessage("WDUF_ITEM_MENU_RENAME"),items:[{html:['<textarea class="disk-file-popup-rename-file-textarea"\n\t\t\t\t\t\t\t\t\t\t\tname="rename" onkeydown="if(event.keyCode===13){ BX.fireEvent(event.target.parentNode.querySelector(\'input[name=save]\'), \'click\'); }"\n\t\t\t\t\t\t\t\t\t\t\tplaceholder="'.concat(r.Text.encode(s),'">').concat(r.Text.encode(s),"</textarea>"),'<div class="ui-btn-container ui-btn-container-center">\n\t\t\t\t\t\t\t\t\t\t\t<input type="button" class="ui-btn ui-btn-sm ui-btn-primary" name="save" value="'.concat(r.Loc.getMessage("WDUF_ITEM_MENU_RENAME_SAVE"),'">\n\t\t\t\t\t\t\t\t\t\t\t<input type="button" class="ui-btn ui-btn-sm ui-btn-link" value="').concat(r.Loc.getMessage("WDUF_ITEM_MENU_RENAME_CANCEL"),'">\n\t\t\t\t\t\t\t\t\t\t</div>')].join(""),className:"menu-popup-item-rename-form",onclick:function e(i,s){if(r.Type.isDomNode(i.target)&&i.target.type==="button"){if(i.target.name==="save"){t.onRenamed([s.getContainer().querySelector("textarea").value,n].join(""));t.clearMenu()}a.close()}}}]}:null,{delimiter:true,text:[r.Loc.getMessage("WDUF_ITEM_MENU_FILE"),r.Text.encode(t.data["SIZE"])].join(" ")},t.data["CAN_MOVE"]===true?{dataset:{bxRole:"moveFile"},text:r.Text.encode(t.data["STORAGE"]),className:"menu-popup-item-storage",onclick:function e(i,n){var r;i["counter"]=((r=i["counter"])!==null&&r!==void 0?r:1)+1;a.close();t.onClickMoveTo(i,n)}}:{text:r.Text.encode(t.data["STORAGE"]),className:"menu-popup-item-storage"}].filter((function(e){return e!==null})),angle:true,offsetLeft:9});return a}))}},{key:"clearMenu",value:function e(){if(this.cache.has("menu")){this.cache.get("menu").destroy();this.cache["delete"]("menu")}}},{key:"onClick",value:function e(t){this.emit("onClick")}},{key:"onClickDelete",value:function e(t){t.preventDefault();t.stopPropagation();this.emit("onDelete");this.destroy();k.deleteAction(this.getId())}},{key:"onClickInsertInText",value:function e(t){this.emit("onClickInsertInText")}},{key:"onClickMore",value:function e(t){t.preventDefault();t.stopPropagation();this.getMenu().show()}},{key:"onClickEdit",value:function e(){}},{key:"onClickMoveTo",value:function e(t,i,n){var a=s.EventEmitter.emit(BX.DiskFileDialog,"onFileNeedsToMove",[this]);return a.length>0}},{key:"onMoved",value:function e(t){var i=t.data;this.data["STORAGE"]=i;this.clearMenu()}},{key:"onRenamed",value:function e(t){if(this.getData("NAME")===t){return}this.rename(t);k.renameAction(this.getId(),t)}},{key:"getHTMLForHTMLEditor",value:function e(t){if(this.getData("TYPE_FILE")==="player"){return'<img contenteditable="false" class="bxhtmled-player-surrogate" data-bx-file-id="'.concat(r.Text.encode(this.data.ID),'" id="').concat(t,'" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" />')}return'<span contenteditable="false" data-bx-file-id="'.concat(r.Text.encode(this.data.ID),'" id="').concat(t,'" style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;">').concat(r.Text.encode(this.data.NAME),"</span>")}}],[{key:"detect",value:function e(){return true}}]);return t}(s.EventEmitter);function M(e){var t=this;if(babelHelpers.classPrivateFieldGet(this,H)){return}var i=e.currentTarget;var n=i.offsetWidth;babelHelpers.classPrivateFieldSet(this,H,new BX.PopupWindow({content:r.Loc.getMessage("WDUF_ITEM_MENU_INSERT_INTO_THE_TEXT"),cacheable:false,animation:"fading-slide",bindElement:i,offsetTop:0,bindOptions:{position:"top"},darkMode:true,events:{onClose:function e(){babelHelpers.classPrivateFieldGet(t,H).destroy();babelHelpers.classPrivateFieldSet(t,H,null)},onShow:function e(t){var i=t.getTarget();i.getPopupContainer().style.display="block";var a=n/2-i.getPopupContainer().offsetWidth/2;i.setOffset({offsetLeft:a+40});i.setAngle({offset:i.getPopupContainer().offsetWidth/2-17})}}}));babelHelpers.classPrivateFieldGet(this,H).show()}function R(e){if(!babelHelpers.classPrivateFieldGet(this,H)){return}babelHelpers.classPrivateFieldGet(this,H).close();babelHelpers.classPrivateFieldSet(this,H,null)}var B;var j=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++){a[s]=arguments[s]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"cache",new r.Cache.MemoryCache);return i}babelHelpers.createClass(t,[{key:"setData",value:function e(t){this.data=t;this.data.BIG_REVIEW_URL=this.data.PREVIEW_URL.replace(/\&(width|height)\=\d+/gi,"")}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){var e=r.Text.encode(t.getNameWithoutExtension());var i=r.Text.encode(t.data["EXTENSION"]).toLowerCase();return r.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="disk-file-thumb disk-file-thumb-preview">\n\t\t\t<div style="background-image: url(\'','\'); background-size: cover;" class="disk-file-thumb-image"></div>\n\t\t\t',"\n\t\t\t","\n\t\t\t","\n\t\t\t","\n\t\t</div>"])),encodeURI(t.data["PREVIEW_URL"]),t.getIcon(i),t.getNameBox(e,i),t.getDeleteButton(),t.getButtonBox())}))}},{key:"getHTMLForHTMLEditor",value:function e(t){return'<img style="max-width: 90%;" data-bx-file-id="'.concat(r.Text.encode(this.data.ID),'" id="').concat(t,'" src="').concat(this.data.BIG_REVIEW_URL,'" />')}}],[{key:"detect",value:function e(t){return!!t["PREVIEW_URL"]}}]);return t}(P);function X(e,t){W(e,t);t.add(e)}function W(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function V(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var G=0;var z=new WeakSet;var Y=function(){function e(t){babelHelpers.classCallCheck(this,e);X(this,z);babelHelpers.defineProperty(this,"tag","[DISK FILE ID=#id#]");babelHelpers.defineProperty(this,"regexp",/\[(?:DOCUMENT ID|DISK FILE ID)=([n0-9]+)\]/gi);this.id=["diskfile"+G++].join("_");this.items=t.items}babelHelpers.createClass(e,[{key:"getInterface",value:function e(){var t=this;return{id:this.id,init:function e(i){t.htmlEditor=i},parse:this.parse.bind(this),unparse:this.unparse.bind(this)}}},{key:"hasInterface",value:function e(){return this.regexp!==null&&this.tag!==null}},{key:"setParams",value:function e(t){var i=t.tag,n=t.regexp;if(r.Type.isStringFilled(i)&&i!=="null"){this.tag=i}else{this.tag=null}if(r.Type.isStringFilled(n)&&n!=="null"){this.regexp=new RegExp(n)}else if(n instanceof RegExp){this.regexp=n}else{this.regexp=null}}},{key:"insertFile",value:function e(t){var i=this.items.get(String(t));if(i){var n=i instanceof j?"\n":" ";var a=i instanceof j?"<br>":"&nbsp;";s.EventEmitter.emit(this.htmlEditor,"OnInsertContent",[n+this.getItemBBCode(t)+n,a+this.getItemHTML(t)+a])}}},{key:"getItemBBCode",value:function e(t){var i=this.items.get(String(t));if(i&&i.isPluggedIn()){i.setInsertedInText()}return this.tag.replace("#id#",t)}},{key:"getItemHTML",value:function e(t){var i=this.items.get(String(t));if(i){return V(this,z,K).call(this,i,t)}return null}},{key:"deleteFile",value:function e(t){if(!this.items.has(t)){return}var i=this.items.get(t).getAllIds();if(this.htmlEditor.GetViewMode()==="wysiwyg"){var n=this.htmlEditor.GetIframeDoc();for(var a in this.htmlEditor.bxTags){if(this.htmlEditor.bxTags.hasOwnProperty(a)&&babelHelpers["typeof"](this.htmlEditor.bxTags[a])==="object"&&this.htmlEditor.bxTags[a]["tag"]===this.id&&i.indexOf(String(this.htmlEditor.bxTags[a]["itemId"]))>=0&&n.getElementById(a)){var r=n.getElementById(a);r.parentNode.removeChild(r)}}this.htmlEditor.SaveContent()}else{var s=this.htmlEditor.GetContent().replace(this.regexp,(function(e,t){return i.indexOf(t)>=0?"":e}));this.htmlEditor.SetContent(s);this.htmlEditor.Focus()}}},{key:"parse",value:function e(t){if(!this.regexp.test(t)){return t}t=t.replace(this.regexp,function(e,t){var i=this.items.has(t)?this.items.get(t):babelHelpers.toConsumableArray(this.items.values()).find((function(e){return e.getAllIds().indexOf(t)>=0}));if(i){return V(this,z,K).call(this,i,t)}return e}.bind(this));return t}},{key:"unparse",value:function e(t,i){var n=i.node;var a=t.itemId;if(this.items.has(a)){return this.getItemBBCode(a)}return""}}]);return e}();function K(e,t){if(e.isPluggedIn()){e.setInsertedInText()}return e.getHTMLForHTMLEditor(this.htmlEditor.SetBxTag(false,{tag:this.id,fileId:t,itemId:e.getId()}))}var q=[P,j];function Z(e){var t=P;q.forEach((function(i){if(i.detect(e)){t=i}}));return new t(e)}var J=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.id,a=e.container,r=e.fieldName,s=e.multiple,o=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:a.querySelector('[data-bx-role="placeholder"]'),eventObject:o}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"maxVisibleCount",10);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"prefixHTMLNode","disk-attach-");i.items=new Map;i.multiple=s!==false;i.fieldName=r;if(!a.querySelector('[data-bx-role="placeholder"]')){return babelHelpers.possibleConstructorReturn(i)}if(i.isPluggedIn()){i.buildInHTMLEditor()}return i}babelHelpers.createClass(t,[{key:"buildInHTMLEditor",value:function e(){var t=this;if(this.getParser().hasInterface()){s.EventEmitter.emit(this.eventObject,"OnParserRegister",this.getParser().getInterface())}s.EventEmitter.subscribe(this.eventObject,"onReinitializeBefore",(function(e){var i=babelHelpers.slicedToArray(e.data,2),n=i[0],a=i[1];var s=true;if(a){Object.values(a).forEach((function(e){if(e&&e["USER_TYPE_ID"]==="disk_file"&&e["FIELD_NAME"].replace("[]","")===t.fieldName.replace("[]","")){try{var i=[];var n={};if(r.Type.isArray(e["VALUE"])){e["VALUE"].forEach((function(e){var a=document.querySelector(["#",t.prefixHTMLNode,e].join(""));var s=String(e);if(!a||n[s]){return}n[s]=true;var o=a.querySelector("img")||a.querySelector("div[data-bx-preview]");var l=o||a;var c=l.hasAttribute("data-title")?l.getAttribute("data-title"):l.hasAttribute("data-bx-title")?l.getAttribute("data-bx-title"):"";var u={ID:e,FILE_ID:l.getAttribute("bx-attach-file-id"),CAN_RESTORE:false,CAN_UPDATE:false,CAN_RENAME:false,CAN_MOVE:false,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:null,BIG_PREVIEW_URL:null,EXTENSION:c.split(".").pop(),NAME:c,SIZE:l.getAttribute("data-bx-size"),SIZE_BYTES:l.getAttribute("data-bx-size"),STORAGE:"disk",TYPE_FILE:l.getAttribute("bx-attach-file-type")};if(o){u["PREVIEW_URL"]=o.hasAttribute("data-bx-preview")&&r.Type.isStringFilled(o.getAttribute("data-bx-preview"))?o.getAttribute("data-bx-preview"):o.hasAttribute("data-thumb-src")&&r.Type.isStringFilled(o.getAttribute("data-thumb-src"))?o.getAttribute("data-thumb-src"):o.src;u["BIG_PREVIEW_URL"]=o.hasAttribute("data-bx-src")?o.getAttribute("data-bx-src"):o.getAttribute("data-src")}i.push(u)}))}t.set(i);s=false}catch(e){console.log("e: ",e)}}}))}if(s!==false){t.clear()}}))}},{key:"set",value:function e(t){var i=this;this.clear();var n=this.maxVisibleCount;return new Promise((function(e){t.forEach((function(e){var t=i.addItem(e);n--;if(n>0){i.appendNode(t)}else if(n===0){i.container.appendChild(i.getItemMore().reset().getContainer())}else{i.getItemMore().increment()}}));e()}))}},{key:"clear",value:function e(){this.items.forEach((function(e){e.destroy()}));this.container.innerHTML=""}},{key:"add",value:function e(t,i){this.multiple||this.clear();var n=this.addItem(t);this.appendNode(n,i);return n}},{key:"addItem",value:function e(t){var i=this;var n=Z(t);var a=this.getContainer().querySelector('[data-bx-role="reserve-item"][value="'.concat(r.Text.encode(n.getId()),'"]'));if(!a){a=document.createElement("INPUT");a.name=this.fieldName;a.type="hidden";a.value=n.getId();this.container.appendChild(a)}n.subscribe("onDelete",(function(){if(a&&a.parentNode){a.parentNode.removeChild(a)}s.EventEmitter.emit(i,"OnItemDelete",n)}));n.subscribe("onDestroy",(function(){i.items["delete"](n.getId())}));if(this.isPluggedIn()){s.EventEmitter.emit(this.eventObject,"onShowControllers:File:Increment");if(this.getParser().hasInterface()){n.setPluggedIn();n.subscribe("onClickInsertInText",(function(){i.getParser().insertFile(n.getId())}));n.subscribe("onDelete",(function(){i.getParser().deleteFile(n.getId())}));n.subscribe("onDestroy",(function(){s.EventEmitter.emit(i.eventObject,"onShowControllers:File:Decrement")}))}}this.items.set(n.getId(),n);return n}},{key:"getItem",value:function e(t){return this.items.get(t)}},{key:"appendNode",value:function e(t,i){if(i){if(i.parentNode){i.parentNode.replaceChild(t.getContainer(),i)}}else{this.container.appendChild(t.getContainer())}return t}},{key:"getItemMore",value:function e(){var t=this;return this.cache.remember("moreButton",(function(){var e=new I;s.EventEmitter.subscribe(e,"onGetMore",t.showMoreItems.bind(t));return e}))}},{key:"showMoreItems",value:function e(t){var i=t.data.itemsCount;var n=i;var a=this.getItemMore().getContainer();a.style.opacity="0";a.style.visibility="hidden";this.items.forEach((function(e){if(i>0){if(!e.hasContainer()){i--;var t=document.createElement("DIV");a.parentNode.insertBefore(t,a);setTimeout((function(){r.Dom.style(e.getContainer(),"opacity","0");r.Dom.addClass(e.getContainer(),"disk-file-thumb--animate");r.Dom.style(e.getContainer(),"opacity","");t.parentNode.replaceChild(e.getContainer(),t);e.getContainer().addEventListener("transitionend",(function(){r.Dom.removeClass(e.getContainer(),"disk-file-thumb--animate")}))}),(n-i)*100)}}}));if(i<=0){setTimeout((function(){a.style.opacity="";a.style.visibility=""}),n*100+100)}}},{key:"getParser",value:function e(){this.parser=this.parser||new Y(this);return this.parser}}]);return t}(E);var $=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:n.querySelector('[data-bx-role="setting"]'),eventObject:a}));if(i.getContainer()){i.getContainer().addEventListener("click",i.show.bind(babelHelpers.assertThisInitialized(i)));i.allowEditNode=n.querySelector('input[data-bx-role="settings-allow-edit"]');i.allowGridNode=n.querySelector('input[data-bx-role="settings-allow-grid"]')}return i}babelHelpers.createClass(t,[{key:"show",value:function e(){var t=this;if(!this.popup){this.popup=new i.Menu({bindElement:this.getContainer(),className:"disk-uf-file-popup-settings",items:[this.allowEditNode?{dataset:{bxRole:"allowEdit"},className:this.allowEditNode.checked?"menu-popup-item-take":"",text:r.Loc.getMessage("WDUF_ALLOW_EDIT"),onclick:function(e,t){this.allowEditNode.checked=!this.allowEditNode.checked;if(this.allowEditNode.checked){t.getContainer().classList.add("menu-popup-item-take");t.getContainer().classList.remove("menu-popup-no-icon")}else{t.getContainer().classList.remove("menu-popup-item-take");t.getContainer().classList.add("menu-popup-no-icon")}}.bind(this)}:null,{dataset:{bxRole:"allowGrid"},className:this.allowGridNode.checked?"menu-popup-item-take":"",text:r.Loc.getMessage("WDUF_ALLOW_COLLAGE"),onclick:function(e,t){this.allowGridNode.checked=!this.allowGridNode.checked;if(this.allowGridNode.dataset.bxSave==="Y"){BX.userOptions.save("disk","disk.uf.file",this.allowGridNode.dataset.bxName,this.allowGridNode.checked?"grid":".default")}if(this.allowGridNode.checked){t.getContainer().classList.add("menu-popup-item-take");t.getContainer().classList.remove("menu-popup-no-icon")}else{t.getContainer().classList.remove("menu-popup-item-take");t.getContainer().classList.add("menu-popup-no-icon")}}.bind(this)},{text:this.buildDocumentServiceTextLabel(),items:this.buildSubMenuWithDocumentServices()}],angle:true,offsetTop:-16,offsetLeft:16,events:{onClose:function e(){delete t.popup}}})}this.popup.show()}},{key:"buildDocumentServiceTextLabel",value:function e(){var t=BX.Disk.getDocumentService();if(!t&&BX.Disk.isAvailableOnlyOffice()){t="onlyoffice"}else if(!t){t="l"}var i=o.getDocumentHandler(t).name;return r.Loc.getMessage("DISK_UF_FILE_EDIT_SERVICE_LABEL",{"#NAME#":i})}},{key:"buildSubMenuWithDocumentServices",value:function e(){var t=this;var i=[];o.getDocumentHandlers().forEach((function(e){i.push({text:e.name,dataset:{code:e.code},onclick:function e(i,n){BX.Disk.saveDocumentService(n.dataset.code);n.getMenuWindow().getParentMenuItem().setText(t.buildDocumentServiceTextLabel());n.getMenuWindow().getPopupWindow().close()}})}));return i}},{key:"hide",value:function e(){if(this.popup){this.popup.close()}}}]);return t}(E);var Q=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:n.querySelector('[data-bx-role="document-area"]'),eventObject:a}));if(i.getContainer()){Array.from(i.getContainer().querySelectorAll("[data-bx-handler]")).forEach((function(e){e.addEventListener("click",(function(){i.createDocument(e.getAttribute("data-bx-handler"))}))}))}return i}babelHelpers.createClass(t,[{key:"createDocument",value:function e(t){if(!BX.Disk.getDocumentService()&&BX.Disk.isAvailableOnlyOffice()){BX.Disk.saveDocumentService("onlyoffice")}else if(!BX.Disk.getDocumentService()){BX.Disk.saveDocumentService("l")}var i=function(e){var t=this;var i=e.object.name.split(".");i.pop();setTimeout((function(){s.EventEmitter.emit(t,"onFileIsCreated",{itemData:t.convertToItemSavedType(e)})}),200)}.bind(this);if(BX.Disk.Document.Local.Instance.isSetWorkWithLocalBDisk()){BX.Disk.Document.Local.Instance.createFile({type:t}).then(function(e){i(e)}.bind(this));return}var n=new BX.Disk.Document.CreateProcess({typeFile:t,serviceCode:BX.Disk.getDocumentService(),onAfterSave:function e(t,n){if(t.status!=="success"){return}if(!n){k.getMetaDataForCreatedFileInUf(t.object.id).then((function(e){var t=e.data;i(t)}))}else{i(n)}}});n.start()}},{key:"convertToItemSavedType",value:function e(t){return{ID:"n"+t.object.id,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:false,CAN_RESTORE:false,CAN_UPDATE:true,CAN_RENAME:true,CAN_MOVE:true,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:t.link,PREVIEW_URL:null,BIG_PREVIEW_URL:null,EXTENSION:t.object.extension,NAME:t.object.name,SIZE:t.object.size,SIZE_BYTES:t.object.sizeInt,STORAGE:t.folderName}}}]);return t}(E);var ee=function(e){babelHelpers.inherits(t,e);function t(e){var i=e.container,n=e.eventObject;babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:i.querySelector('[data-bx-role="control-panel"]'),eventObject:n}))}return t}(E);var te=0;var ie=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);var r=n.querySelector('[data-bx-role="file-local-controller"]')||n.querySelector(".diskuf-selector-link");i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:r,eventObject:a}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"opened",false);i.dialogName=["selectFile",te++].join("-");if(!i.getContainer()){return babelHelpers.possibleConstructorReturn(i)}i.getContainer().addEventListener("click",i.onClick.bind(babelHelpers.assertThisInitialized(i)));i.openSection=i.openSection.bind(babelHelpers.assertThisInitialized(i));i.selectFile=i.selectFile.bind(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(BX.DiskFileDialog,"loadItems",i.openSection);return i}babelHelpers.createClass(t,[{key:"onClick",value:function e(){var t=this;k.getSelectedData(this.dialogName).then((function(){setTimeout((function(){BX.DiskFileDialog.obCallback[t.dialogName]={saveButton:t.selectFile};BX.DiskFileDialog.openDialog(t.dialogName)}),10)}))}},{key:"openSection",value:function e(t){var i=babelHelpers.slicedToArray(t.data,2),n=i[0],a=i[1];if(a===this.dialogName){BX.DiskFileDialog.target[a]=r.Uri.addParam(n,{dialog2:"Y"})}}},{key:"selectFile",value:function e(t,i,n){s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);for(var a in n){if(n.hasOwnProperty(a)){s.EventEmitter.emit(this,"onUploadDone",{itemData:this.convertToItemSavedType(n[a])})}}}},{key:"convertToItemSavedType",value:function e(t){var i;return{ID:t.id,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:false,CAN_RESTORE:false,CAN_RENAME:false,CAN_UPDATE:false,CAN_MOVE:false,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:t.previewUrl?t.previewUrl:"",BIG_PREVIEW_URL:t.previewUrl?t.previewUrl.replace(/\&(width|height)=\d+/gi,""):null,EXTENSION:t.ext,NAME:t.name,SIZE:t.size,SIZE_BYTES:t.sizeInt,STORAGE:(i=t["storage"])!==null&&i!==void 0?i:r.Loc.getMessage("WDUF_MY_DISK")}}}]);return t}(E);var ne=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,i));BX.Disk.ExternalLoader.startLoad({file:{id:n.id,name:n.object.name,service:n.object.service},onFinish:function e(t){s.EventEmitter.emit(babelHelpers.assertThisInitialized(n),"onUploadDone",[t])},onProgress:function e(t){n.onUploadProgress({compatData:[{},t]})}});return n}babelHelpers.createClass(t,[{key:"onClickDelete",value:function e(t){t.preventDefault();t.stopPropagation();s.EventEmitter.emit(this,"onDelete",[this]);delete this.container}},{key:"onUploadDone",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,2),n=i[0],a=i[1].file}},{key:"onUploadError",value:function e(t){var i=babelHelpers.slicedToArray(t.compatData,1),n=i[0];s.EventEmitter.emit(this,"onUploadError",[n.file]);this.progress.getContainer().parentNode.removeChild(this.progress.getContainer());this.container.classList.add("disk-file-upload-error")}}]);return t}(c);var ae=0;var re=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.container,a=e.eventObject;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:n.querySelector('[data-bx-role="placeholder"]'),eventObject:a}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"services",[]);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"items",new Map);if(!i.getContainer()){return babelHelpers.possibleConstructorReturn(i)}Array.from(n.querySelectorAll('[data-bx-role="file-external-controller"]')).forEach((function(e){i.services.push(e)}));Array.from(n.querySelectorAll(".diskuf-selector-link-cloud")).forEach((function(e){i.services.push(e)}));i.eventObject=a;i.dialogName=["selectFileCloud",ae++].join("-");i.services.forEach((function(e){e.addEventListener("click",i.onClick.bind(babelHelpers.assertThisInitialized(i)))}));i.openSection=i.openSection.bind(babelHelpers.assertThisInitialized(i));i.selectFile=i.selectFile.bind(babelHelpers.assertThisInitialized(i));return i}babelHelpers.createClass(t,[{key:"onClick",value:function e(t){var i=this;s.EventEmitter.subscribe(BX.DiskFileDialog,"loadItems",this.openSection);this.currentService=t.currentTarget.getAttribute("data-bx-doc-handler");k.getSelectedCloudData(this.dialogName,this.currentService).then((function(){setTimeout((function(){BX.DiskFileDialog.obCallback[i.dialogName]={saveButton:i.selectFile};BX.DiskFileDialog.openDialog(i.dialogName)}),10)}))}},{key:"openSection",value:function e(t){var i=babelHelpers.slicedToArray(t.data,2),n=i[0],a=i[1];if(a===this.dialogName){BX.DiskFileDialog.target[a]=r.Uri.addParam(n,{dialog2:"Y"})}}},{key:"selectFile",value:function e(t,i,n){s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);for(var a in n){if(n.hasOwnProperty(a)&&n[a].type==="file"){this.catchFile(n[a],this.currentService)}}this.currentService=null}},{key:"catchFile",value:function e(t,i){var n=this;if(this.items.has(t.id)){return}t["service"]=t["provider"]||i;var a=new ne(t.id,t);this.items.set(a.id,a);s.EventEmitter.subscribe(a,"onUploadDone",(function(e){var t=babelHelpers.slicedToArray(e.data,1),i=t[0];if(n.items.has(a.id)){n.items["delete"](a.id);s.EventEmitter.emit(n,"onUploadDone",{itemData:n.convertToItemSavedType(i),itemContainer:a.getContainer()})}}));s.EventEmitter.subscribe(a,"onUploadError",(function(){n.items["delete"](a.id);s.EventEmitter.emit(n,"onUploadError",{itemContainer:a.getContainer()})}));s.EventEmitter.subscribe(a,"onDelete",(function(){n.items["delete"](a.id);n.container.removeChild(a.getContainer())}));this.container.appendChild(a.getContainer())}},{key:"convertToItemSavedType",value:function e(t){var i=t.name.split(".").pop().toLowerCase();var n={ID:t.ufId,IS_LOCKED:false,IS_MARK_DELETED:false,EDITABLE:false,FROM_EXTERNAL_SYSTEM:true,CAN_RESTORE:false,CAN_RENAME:false,CAN_UPDATE:false,CAN_MOVE:false,COPY_TO_ME_URL:null,DELETE_URL:null,DOWNLOAD_URL:null,EDIT_URL:null,VIEW_URL:null,PREVIEW_URL:t.previewUrl?t.previewUrl:"",BIG_PREVIEW_URL:t.previewUrl?t.previewUrl.replace(/\&(width|height)=\d+/gi,""):null,EXTENSION:i===t.name?"":i,NAME:t.name,SIZE:t.sizeFormatted,SIZE_BYTES:t.size,STORAGE:t.storage};return n}}]);return t}(E);var se=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"dialogName","moveFile");this.openSection=this.openSection.bind(this);this.loadFolder=this.loadFolder.bind(this);this.stopLoadingFolder=this.stopLoadingFolder.bind(this);this.checkFileName=this.checkFileName.bind(this);this.onApply=this.onApply.bind(this);this.onCancel=this.onCancel.bind(this)}babelHelpers.createClass(e,[{key:"fire",value:function e(t){var i=this;if(this.item!==null&&this.item!==t){this.onCancel()}this.item=t;k.getSelectedFile(t.getFileId(),t.getData("NAME"),this.dialogName).then((function(){setTimeout((function(){BX.DiskFileDialog.obCallback[i.dialogName]={saveButton:i.onApply,cancelButton:i.onCancel};BX.DiskFileDialog.openDialog(i.dialogName)}),10)}));s.EventEmitter.subscribe(BX.DiskFileDialog,"loadItems",this.openSection);s.EventEmitter.subscribe(BX.DiskFileDialog,"selectItem",this.loadFolder);s.EventEmitter.subscribe(BX.DiskFileDialog,"unSelectItem",this.stopLoadingFolder)}},{key:"openSection",value:function e(t){var i=babelHelpers.slicedToArray(t.data,2),n=i[0],a=i[1];if(a===this.dialogName){BX.DiskFileDialog.target[a]=r.Uri.addParam(n,{dialog2:"Y"})}}},{key:"loadFolder",value:function e(t){var i=this;var n=babelHelpers.slicedToArray(t.data,3),a=n[0],s=n[1],o=n[2];if(o!==this.dialogName){return}k.loadFolder(s.substr(1),this.item.getData("NAME"),this.dialogName).then((function(e){var t=e.permission===true&&e["okmsg"]!=="";if(i.timeout>0){clearTimeout(i.timeout)}i.timeout=setTimeout((function(){if(t){BX.DiskFileDialog.showNotice(r.Loc.getMessage("WDUF_FILE_IS_EXISTS"),i.dialogName)}else{BX.DiskFileDialog.closeNotice(i.dialogName)}}),200)}))}},{key:"stopLoadingFolder",value:function e(t){var i=t.data;if(this.timeout>0){clearTimeout(this.timeout)}this.timeout=setTimeout(this.checkFileName,200)}},{key:"onApply",value:function e(t,i,n,a){var r=this;s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"selectItem",this.loadFolder);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"unSelectItem",this.stopLoadingFolder);if(!this.item){return}var o=this.item.getId();var l=false;var c=function e(t,i,n,a){k.moveFile(t,i).then((function(e){if(!e||e.status!=="success"){BX.Disk.showModalWithStatusAction(e);return}r.showMovedFile(t,n,a)}))};var u,d;for(var h in n){if(n.hasOwnProperty(h)&&n[h].type==="folder"){u=t.name+n[h].path;d={sectionID:h,iblockID:t.iblock_id};c(o,n[h].id,d,u);l=true}}if(!l){u=t.name;d={sectionID:t.section_id,iblockID:t.iblock_id};if(!!a&&!!a.path&&a.path!=="/"){u+=a.path;d.sectionID=a.id;if(!!a){c(o,a.id,d,u)}}}}},{key:"checkFileName",value:function e(t){if(this.timeout>0){clearTimeout(this.timeout)}if(t!==this.dialogName||!this.item){return}var i=this.item.getData("NAME");var n=false;for(var a in BX.DiskFileDialog.obItems[this.dialogName]){if(BX.DiskFileDialog.obItems[this.dialogName].hasOwnProperty(a)&&BX.DiskFileDialog.obItems[this.dialogName][a]["name"]===i){n=true;break}}if(n){BX.DiskFileDialog.showNotice(r.Loc.getMessage("WDUF_FILE_IS_EXISTS"),this.dialogName)}else{BX.DiskFileDialog.closeNotice(this.dialogName)}}},{key:"showMovedFile",value:function e(t,i,n){if(this.item){this.item.emit("onMoved",n)}this.item=null}},{key:"onCancel",value:function e(){s.EventEmitter.unsubscribe(BX.DiskFileDialog,"loadItems",this.openSection);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"selectItem",this.loadFolder);s.EventEmitter.unsubscribe(BX.DiskFileDialog,"unSelectItem",this.stopLoadingFolder);this.item=null;if(this.timeout>0){clearTimeout(this.timeout)}this.timeout=null}}],[{key:"subscribe",value:function t(){if(BX.DiskFileDialog.subscribed!==true){BX.DiskFileDialog.subscribed=true;s.EventEmitter.subscribe(BX.DiskFileDialog,"onFileNeedsToMove",(function(t){t.stopImmediatePropagation();e.getInstance().fire(babelHelpers.toConsumableArray(t.getData()).shift())}))}}},{key:"getInstance",value:function t(){if(this.instance===null){this.instance=new e}return this.instance}}]);return e}();babelHelpers.defineProperty(se,"subscribed",false);babelHelpers.defineProperty(se,"instance",null);var oe,le;var ce=0;function ue(e){var t={},i,n;for(i in e){n=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[n]=e[i];t[i]=e[i]}return t}var de=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=e.id,a=e.fieldName,r=e.container,l=e.eventObject,c=e.input;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:r,eventObject:l}));i.id=n;i.fieldName=a;i.input=c;if(!i.input){return babelHelpers.possibleConstructorReturn(i)}i.agent=BX.Uploader.getInstance({id:n,streams:1,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:o.urlUpload,showImage:false,sortItems:false,dropZone:null,input:i.input,pasteFileHashInForm:false});i.onUploadDone=i.onUploadDone.bind(babelHelpers.assertThisInitialized(i));i.onUploadError=i.onUploadError.bind(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(i.agent,"onFileIsUploaded",(function(e){var t=babelHelpers.slicedToArray(e.compatData,3),n=t[0],a=t[1],r=t[2];i.onUploadDone(a,r)}));s.EventEmitter.subscribe(i.agent,"onFileIsUploadedWithError",(function(e){var t=babelHelpers.slicedToArray(e.compatData,3),n=t[0],a=t[1],r=t[2];i.onUploadError(a,r)}));i.fileSelector=new ie(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(i.fileSelector,"onUploadDone",(function(e){var t=e.data.itemData;i.onSelectionIsDone(t)}));i.fileSelectorCloud=new re(babelHelpers.assertThisInitialized(i));s.EventEmitter.subscribe(i.fileSelectorCloud,"onUploadDone",(function(e){var t=e.data.itemData;i.onSelectionIsDone(t)}));return i}babelHelpers.createClass(t,[{key:"onSelectionIsDone",value:function e(t){var i={id:"disk-edit-attach"+t["ID"],"bx-agentFileId":t["ID"]};if(t["FILE_ID"])i["bx-attach-file-id"]="n"+t["FILE_ID"];var n=r.Tag.render(oe||(oe=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','" value="','">'])),this.fieldName,t["ID"]);for(var a in i){if(i.hasOwnProperty(a)){n.setAttribute(a,i[a])}}this.getContainer().appendChild(n);var o={element_id:t["ID"],element_name:t["NAME"],element_url:t["PREVIEW_URL"],storage:t["STORAGE"]};s.EventEmitter.emit(this.getEventObject(),"OnFileUploadSuccess",new s.BaseEvent({compatData:[o,{},null,{id:ce++,name:t["NAME"],size:t["SIZE"],sizeInt:t["SIZE_INT"]}]}))}},{key:"onUploadDone",value:function e(t,i){if(i["file"]&&i["file"]["attachId"]!==i["file"]["id"]){i["file"]["id"]=i["file"]["attachId"];delete i["file"]["attachId"]}var n=ue(i["file"]);var a={id:"disk-edit-attach"+n.id,"bx-agentFileId":t.id};if(n["XML_ID"])a["bx-attach-xml-id"]=n["XML_ID"];if(n["FILE_ID"])a["bx-attach-file-id"]="n"+n["FILE_ID"];if(n["FILE_TYPE"])a["bx-attach-file-type"]=n["FILE_TYPE"];n.element_id=n.id;var s=r.Tag.render(le||(le=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','" value="','">'])),this.fieldName,n.id);for(var o in a){if(a.hasOwnProperty(o)){s.setAttribute(o,a[o])}}this.getContainer().appendChild(s);this.onFileIs(t,n)}},{key:"onFileIs",value:function e(t,i){var n={element_id:i.element_id,element_name:i.element_name||t.name,element_url:i.element_name||i.previewUrl||i.preview_url,storage:"disk"};s.EventEmitter.emit(this.getEventObject(),"OnFileUploadSuccess",new s.BaseEvent({compatData:[n,this,t.file,t]}))}},{key:"onUploadError",value:function e(t,i){BX.onCustomEvent(this.getEventObject(),"OnFileUploadFailed",[this,t.file,t])}}]);return t}(E);var he=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;var a=e.id,r=e.fieldName,o=e.container,l=e.eventObject,c=e.input,u=e.parserParams;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{container:o,eventObject:l}));n.id=a;n.fieldName=r;n.input=c;if(u){n.getFileController().getParser().setParams(u)}n.init();if(i.length>0){s.EventEmitter.emit(n.getEventObject(),"onShowControllers","show");n.show(i)}return n}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;if(this.input){this.getFilesUploader()}this.initDocumentController();this.settingsController=new $(this,{});this.panelController=new ee(this);this.fileSelector=new ie(this);s.EventEmitter.subscribe(this.fileSelector,"onUploadDone",(function(e){var i=e.data.itemData;t.getFileController().add(i)}));this.fileSelectorCloud=new re(this);s.EventEmitter.subscribe(this.fileSelectorCloud,"onUploadDone",(function(e){var i=e.data,n=i.itemData,a=i.itemContainer;t.getFileController().add(n,a)}));var i=function e(i){var n=r.Type.isArray(i.getData())?i.getData().shift():i.getData();if(n==="show"){t.show()}else{t.hide()}};s.EventEmitter.subscribe(this.getEventObject(),"onCollectControllers",(function(e){e.data[t.fieldName]={storage:"disk",tag:t.getFileController().isPluggedIn()?t.getFileController().getParser().tag:null,values:[],handler:{selectFile:function e(i,n,a){t.fileSelector.selectFile(i,n,a)}}};Array.from(t.getContainer().querySelectorAll('input[type="hidden"][name="'.concat(t.fieldName,'"]'))).forEach((function(i){e.data[t.fieldName].values.push(i.value)}))}));s.EventEmitter.subscribe(this.getEventObject(),"onShowControllers",i);s.EventEmitter.subscribe(this.getEventObject(),"DiskLoadFormController",i);s.EventEmitter.subscribe(s.EventEmitter.GLOBAL_TARGET,"disk.uf.file:create:thumb:upload",(function(e){var i=e.data;t.show();t.getFilesUploader().addTestThumb(i)}));s.EventEmitter.subscribe(s.EventEmitter.GLOBAL_TARGET,"disk.uf.file:create:thumb:error",(function(){t.show();t.getFilesUploader().addTestErrorThumb()}))}},{key:"initDocumentController",value:function e(){var i=this;this.documentController=new Q({container:this.getContainer(),eventObject:this.getEventObject()});s.EventEmitter.subscribe(this.documentController,"onFileIsCreated",(function(e){var t=e.data.itemData;s.EventEmitter.emit(i.getEventObject(),"onShowControllers","show");i.getFileController().add(t)}));if(!this.documentController.isRelevant()){return}else if(!this.isPluggedIn()){this.documentController.show();return}if(this.eventObject.dataset.bxDiskDocumentButton!=="added"){this.eventObject.dataset.bxDiskDocumentButton="added";var n=document.createElement("DIV");n.addEventListener("click",(function(){var e=n.closest('[data-id="disk-document"]');if(e&&e.hasAttribute("data-bx-button-status")){s.EventEmitter.emit(i.getEventObject(),"onHideDocuments")}else{s.EventEmitter.emit(i.getEventObject(),"onShowControllers","hide");s.EventEmitter.emit(i.getEventObject(),"onShowDocuments","show")}}));n.innerHTML="<i></i>"+r.Loc.getMessage("WDUF_CREATE_DOCUMENT");s.EventEmitter.emit(this.eventObject,"OnAddButton",[{BODY:n,ID:"disk-document"},"file"]);s.EventEmitter.subscribe(this.getEventObject(),"onShowDocuments",(function(){var e=n.closest('[data-id="disk-document"]');if(e){e.setAttribute("data-bx-button-status","active")}}));s.EventEmitter.subscribe(this.getEventObject(),"onHideDocuments",(function(){var e=n.closest('[data-id="disk-document"]');if(e){e.removeAttribute("data-bx-button-status")}}))}s.EventEmitter.subscribe(this.getEventObject(),"onShowDocuments",(function(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"show",i).call(i);i.documentController.show()}));s.EventEmitter.subscribe(this.getEventObject(),"onHideDocuments",(function(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hide",i).call(i);i.documentController.hide()}));var a=function e(t){var n=t.data;if(n==="show"){s.EventEmitter.emit(i.getEventObject(),"onHideDocuments")}};s.EventEmitter.subscribe(this.getEventObject(),"DiskLoadFormController",a);s.EventEmitter.subscribe(this.getEventObject(),"onShowControllers",a)}},{key:"getFileController",value:function e(){if(!this.filesController){this.filesController=new J({id:this.id,fieldName:this.fieldName,container:this.container,eventObject:this.eventObject})}return this.filesController}},{key:"getFilesUploader",value:function e(){var t=this;if(!this.filesUploader){this.filesUploader=new v({id:this.id,container:this.container.querySelector('[data-bx-role="placeholder"]'),dropZone:this.container,input:this.input});s.EventEmitter.subscribe(this.getEventObject(),"OnVideoHasCaught",(function(e){var i=e.getData();var n=function e(n){var a=n.data,r=a.itemData,o=a.itemContainer,l=a.blob;if(i===l){s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",e);t.getFileController().getParser().insertFile(r.ID)}};s.EventEmitter.subscribe(t.filesUploader,"onUploadDone",n);t.filesUploader.upload([i]);e.stopImmediatePropagation()}));s.EventEmitter.subscribe(this.getEventObject(),"OnImageHasCaught",(function(e){var i=e.getData();e.stopImmediatePropagation();return new Promise((function(e,n){var a=function n(a){var o=a.data,l=o.itemData,c=o.itemContainer,u=o.blob;if(i===u){s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",n);s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",r);e({image:{src:l.PREVIEW_URL},html:t.getFileController().getParser().getItemHTML(l.ID)})}};s.EventEmitter.subscribe(t.filesUploader,"onUploadDone",a);var r=function e(r){var o=r.data.blob;if(i===o){s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",a);s.EventEmitter.unsubscribe(t.filesUploader,"onUploadDone",e);n()}};s.EventEmitter.subscribe(t.filesUploader,"onUploadDone",r);t.filesUploader.upload([i])}))}));s.EventEmitter.subscribe(this.getEventObject(),"onFilesHaveCaught",(function(e){e.stopImmediatePropagation();t.filesUploader.upload(babelHelpers.toConsumableArray(e.getData()))}));s.EventEmitter.subscribe(this.filesUploader,"onUploadDone",(function(e){var i=e.data,n=i.itemData,a=i.itemContainer;t.getFileController().add(n,a)}));s.EventEmitter.subscribe(this.filesUploader,"onUploadIsStart",(function(){s.EventEmitter.emit(t.getEventObject(),"onBusy",t)}));s.EventEmitter.subscribe(this.filesUploader,"onUploadIsDone",(function(){s.EventEmitter.emit(t.getEventObject(),"onReady",t)}))}return this.filesUploader}},{key:"getPanelController",value:function e(){return this.panelController}},{key:"show",value:function e(i){var n=this;var a=this.getContainer().parentNode.querySelector("#"+this.getContainer().id+"-switcher");if(a){a.parentNode.removeChild(a)}if(this.getFileController().isPluggedIn()){this.getContainer().setAttribute("data-bx-plugged-in","Y")}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"show",this).call(this);this.showInitialLoader();this.getFileController().show();this.getPanelController().show();if(i){this.getFileController().set(i).then((function(){n.hideInitialLoader()}))}else{this.hideInitialLoader()}}},{key:"hide",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hide",this).call(this);this.getFileController().hide();this.getPanelController().hide()}},{key:"showInitialLoader",value:function e(){}},{key:"hideInitialLoader",value:function e(){}}],[{key:"getInstance",value:function e(i,n){if(!this.repo[i["id"]]){this.repo[i["id"]]=new t(i,n)}return this.repo[i["id"]]}},{key:"getBriefInstance",value:function e(t){if(!this.repo[t["id"]]){this.repo[t["id"]]=new de(t,[])}return this.repo[t["id"]]}}]);return t}(E);babelHelpers.defineProperty(he,"repo",{});setTimeout((function(){if(BX.DiskFileDialog){se.subscribe()}}),1e3);var pe=function e(t){var i=BX("diskuf-selectdialog-"+t["UID"]);if(i&&BX.isNodeInDom(i)){var n=i.parentNode;if(!i.hasAttribute("bx-disk-load-is-bound")){i.setAttribute("bx-disk-load-is-bound","Y");BX.addCustomEvent(n,"DiskLoadFormController",(function(e){try{BX.Disk.UF.Options.set({urlUpload:t.urlUpload});return BX.Disk.UF.Form.getBriefInstance({container:i,eventObject:i.parentNode,id:t.UID,fieldName:t.controlName,input:BX.findChild(i,{className:"diskuf-fileUploader"},true)})}catch(e){console.log("Error with compatibility",e)}}))}if(!!t["values"]&&t["values"].length>0&&!t["hideSelectDialog"])BX.onCustomEvent(i.parentNode,"DiskLoadFormController",["show"])}};e.Form=he;e.Options=o;e.add=pe})(this.BX.Disk.UF=this.BX.Disk.UF||{},BX,BX.Main,BX.UI,BX.UI,BX,BX.Event);(function(e){if(e.BX.Disk&&e.BX.Disk.UFShowController)return;var t=e.BX;var i=0;var n={};var a=function(e){return t.Disk.ajaxPromise({url:t.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","getBreadcrumbs"),method:"POST",dataType:"json",data:{attachedId:e}})};var r=function(e){if(!t(e)||e.hasAttribute("bx-is-bound"))return;e.setAttribute("bx-is-bound","Y");this.img=e;this.node=e.parentNode.parentNode.parentNode;t.unbindAll(e);t.unbindAll(this.node);t.show(this.node);t.remove(this.node.nextSibling);this.id="wufdp_"+Math.random()};r.prototype={turnOn:function(){this.timeout=setTimeout(t.delegate((function(){this.show()}),this),500)},turnOff:function(){clearTimeout(this.timeout);this.timeout=null;this.hide()},show:function(){if(this.popup!=null)this.popup.close();if(this.popup==null){var e={width:this.img.naturalWidth,height:this.img.naturalHeight};if(t["UploaderUtils"]){var i=t.UploaderUtils.scaleImage(e,{width:parseInt(t.message("DISK_THUMB_WIDTH")),height:parseInt(t.message("DISK_THUMB_HEIGHT"))});e=i.destin}this.popup=new t.PopupWindow("bx-wufd-preview-img-"+this.id,this.img.parentNode,{lightShadow:true,offsetTop:-7,offsetLeft:(51-28)/2+14,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:t.proxy((function(){this.popup=null}),this)},content:t.create("DIV",{props:e,children:[t.create("IMG",{props:e,attrs:{src:this.img.src}})]})});this.popup.show()}this.popup.setAngle({position:"bottom"});this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();this.popup.bindOptions.forceBindPosition=false},hide:function(){if(this.popup!=null)this.popup.close()}};t.addCustomEvent("onDiskPreviewIsReady",(function(e){new r(e)}));t.Disk.UF.runImport=function(e){t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_PROCESS_LOADING"),showLoaderIcon:true,autoHide:false});t.Disk.ExternalLoader.reloadLoadAttachedObject({attachedObject:{id:e.id,name:e.name,service:e.service},onFinish:t.delegate((function(e){if(e.hasOwnProperty("hasNewVersion")&&!e.hasNewVersion){t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_HAS_LAST_VERSION"),showSuccessIcon:true,autoHide:true})}else if(e.status==="success"){t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_SUCCESS_LOADING"),showSuccessIcon:true,autoHide:true})}else{t.Disk.showActionModal({text:t.message("DISK_UF_FILE_STATUS_FAIL_LOADING"),autoHide:true})}}),this),onProgress:t.delegate((function(e){}),this)}).start()};t.Disk.UF.disableAutoCommentToAttachedObject=function(e){var i=e.attachedId;t.Disk.ajax({method:"POST",dataType:"json",url:t.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","disableAutoCommentToAttachedObject"),data:{attachedId:i},onsuccess:t.delegate((function(e){}),this)})};t.Disk.UF.enableAutoCommentToAttachedObject=function(e){var i=e.attachedId;t.Disk.ajax({method:"POST",dataType:"json",url:t.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","enableAutoCommentToAttachedObject"),data:{attachedId:i},onsuccess:t.delegate((function(e){}),this)})};t.Disk.UF.showTransformationUpgradePopup=function(e){B24.licenseInfoPopup.show("disk_transformation_video_limit",t.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_TITLE"),t.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_CONTENT"),false)};t.Disk.UFShowController=function(e){if(!t.type.isPlainObject(e)){e={}}this.entityType=t.type.isNotEmptyString(e.entityType)?e.entityType:"";this.entityId=parseInt(e.entityId)>0?e.entityId:"";this.signedParameters=t.type.isNotEmptyString(e.signedParameters)?e.signedParameters:"";this.loader=null;this.container=t.type.isNotEmptyString(e.nodeId)?document.getElementById(e.nodeId):null;if(this.container){var i=this.container.querySelector(".disk-uf-file-switch-control");if(i){t.Event.bind(i,"click",t.Disk.UFShowController.onToggleView)}}if(t.type.isNotEmptyString(e.nodeId)){n[e.nodeId]=this}};t.Disk.UFShowController.getInstance=function(e){return t.type.isNotEmptyString(e)&&n[e]?n[e]:null};t.Disk.UFShowController.onToggleView=function(e){var i=e.currentTarget.closest(".diskuf-files-toggle-container"),n=e.currentTarget.getAttribute("data-bx-view-type");if(!t.type.isDomNode(i)||!t.type.isNotEmptyString(i.id)){return}var a=t.Disk.UFShowController.getInstance(i.id);if(a){a.toggleViewType({viewType:n})}e.preventDefault()};t.Disk.UFShowController.prototype.toggleViewType=function(e){this.showToggleViewLoader();t.ajax.runComponentAction("bitrix:disk.uf.file","toggleViewType",{mode:"class",signedParameters:this.signedParameters,data:{params:{viewType:e.viewType}}}).then(function(e){this.hideToggleViewLoader();t.clean(this.container);t.html(this.container,e.data.html)}.bind(this),(function(e){this.hideToggleViewLoader()}))};t.Disk.UFShowController.prototype.showToggleViewLoader=function(e){this.container.classList.add("diskuf-files-toggle-container-active");this.loader=new t.Loader({target:this.container});this.loader.show()};t.Disk.UFShowController.prototype.hideToggleViewLoader=function(e){this.container.classList.remove("diskuf-files-toggle-container-active");if(this.loader){this.loader.destroy()}};e.DiskOpenMenuCreateService=function(e){var i=[t.Disk.UF.getDocumentHandler("onlyoffice")?{text:t.Disk.UF.getDocumentHandler("onlyoffice").name,className:"bx-viewer-popup-item item-b24-docs",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("onlyoffice");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("onlyoffice").name})}}:null,t.Disk.Document.Local.Instance.isEnabled()?{text:t.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT"),className:"bx-viewer-popup-item item-b24",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("l");t.adjust(e,{text:t.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT")})}}:null,{text:t.Disk.UF.getDocumentHandler("gdrive").name,className:"bx-viewer-popup-item item-gdocs",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("gdrive");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("gdrive").name})}},{text:t.Disk.UF.getDocumentHandler("office365").name,className:"bx-viewer-popup-item item-office365",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("office365");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("office365").name})}},{text:t.Disk.UF.getDocumentHandler("onedrive").name,className:"bx-viewer-popup-item item-office",onclick:function(i,n){n.getMenuWindow().close();t.Disk.saveDocumentService("onedrive");t.adjust(e,{text:t.Disk.UF.getDocumentHandler("onedrive").name})}}];t.PopupMenu.show("disk_open_menu_with_services",t(e),i,{offsetTop:0,offsetLeft:25,angle:{position:"top",offset:45},autoHide:true,zIndex:1e4,overlay:{opacity:.01},events:{}})};e.DiskOpenMenuImportService=function(e,i){var n=[];for(var a in i){if(!i.hasOwnProperty(a))continue;n.push({text:i[a].name,code:i[a].id,href:"#",onclick:function(e,i){var n=i.layout.item;t.addClass(n,"diskuf-selector-link-cloud");n.setAttribute("data-bx-doc-handler",i.code);t.onCustomEvent("onManualChooseCloudImport",[{target:n}]);t.removeClass(n,"diskuf-selector-link-cloud");n.removeAttribute("data-bx-doc-handler");t.PopupMenu.destroy("disk_open_menu_with_import_services");return t.PreventDefault(e)}})}var r=new t.CViewer({});r.openMenu("disk_open_menu_with_import_services",t(e),n,{offsetTop:0,offsetLeft:25});return t.PreventDefault()};e.DiskActionFileMenu=function(e,n,a){i++;t.PopupMenu.show("bx-viewer-wd-popup"+i+"_"+e,t(n),a,{angle:{position:"top",offset:25},autoHide:true});return false};e.WDInlineElementClickDispatcher=function(e,i){var n=t(i);if(n){t.fireEvent(n,"click")}return false}})(window);
/* End */
;; /* /bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?168833129470830*/
; /* /bitrix/components/bitrix/system.field.edit/script.min.js?1688331294814*/
; /* /bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?168833132866406*/

//# sourceMappingURL=template_7e866a3174b6647dcb369d1ecadb10d9.map.js